<!DOCTYPE article
PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD with MathML3 v1.3 20210610//EN" "JATS-archivearticle1-3-mathml3.dtd">
<article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" dtd-version="1.3" xml:lang="en" article-type="research-article"><?properties open_access?><processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats"><restricted-by>pmc</restricted-by></processing-meta><front><journal-meta><journal-id journal-id-type="nlm-ta">PLoS Comput Biol</journal-id><journal-id journal-id-type="iso-abbrev">PLoS Comput Biol</journal-id><journal-id journal-id-type="publisher-id">plos</journal-id><journal-title-group><journal-title>PLOS Computational Biology</journal-title></journal-title-group><issn pub-type="ppub">1553-734X</issn><issn pub-type="epub">1553-7358</issn><publisher><publisher-name>Public Library of Science</publisher-name><publisher-loc>San Francisco, CA USA</publisher-loc></publisher></journal-meta>
<article-meta><article-id pub-id-type="pmid">40408328</article-id><article-id pub-id-type="pmc">PMC12101670</article-id><article-id pub-id-type="doi">10.1371/journal.pcbi.1013023</article-id><article-id pub-id-type="publisher-id">PCOMPBIOL-D-24-01678</article-id><article-categories><subj-group subj-group-type="heading"><subject>Software</subject></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Biology and Life Sciences</subject><subj-group><subject>Cell Biology</subject><subj-group><subject>Cellular Types</subject><subj-group><subject>Animal Cells</subject><subj-group><subject>Neurons</subject></subj-group></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Biology and Life Sciences</subject><subj-group><subject>Neuroscience</subject><subj-group><subject>Cellular Neuroscience</subject><subj-group><subject>Neurons</subject></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Research and Analysis Methods</subject><subj-group><subject>Bioassays and Physiological Analysis</subject><subj-group><subject>Electrophysiological Techniques</subject><subj-group><subject>Brain Electrophysiology</subject><subj-group><subject>Electroencephalography</subject></subj-group></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Biology and Life Sciences</subject><subj-group><subject>Physiology</subject><subj-group><subject>Electrophysiology</subject><subj-group><subject>Neurophysiology</subject><subj-group><subject>Brain Electrophysiology</subject><subj-group><subject>Electroencephalography</subject></subj-group></subj-group></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Biology and Life Sciences</subject><subj-group><subject>Neuroscience</subject><subj-group><subject>Neurophysiology</subject><subj-group><subject>Brain Electrophysiology</subject><subj-group><subject>Electroencephalography</subject></subj-group></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Biology and Life Sciences</subject><subj-group><subject>Neuroscience</subject><subj-group><subject>Brain Mapping</subject><subj-group><subject>Electroencephalography</subject></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Medicine and Health Sciences</subject><subj-group><subject>Clinical Medicine</subject><subj-group><subject>Clinical Neurophysiology</subject><subj-group><subject>Electroencephalography</subject></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Research and Analysis Methods</subject><subj-group><subject>Imaging Techniques</subject><subj-group><subject>Neuroimaging</subject><subj-group><subject>Electroencephalography</subject></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Biology and Life Sciences</subject><subj-group><subject>Neuroscience</subject><subj-group><subject>Neuroimaging</subject><subj-group><subject>Electroencephalography</subject></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Research and Analysis Methods</subject><subj-group><subject>Bioassays and Physiological Analysis</subject><subj-group><subject>Electrophysiological Techniques</subject><subj-group><subject>Membrane Electrophysiology</subject><subj-group><subject>Electrode Recording</subject></subj-group></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Physical Sciences</subject><subj-group><subject>Chemistry</subject><subj-group><subject>Electrochemistry</subject><subj-group><subject>Electrode Potentials</subject></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Biology and Life Sciences</subject><subj-group><subject>Anatomy</subject><subj-group><subject>Brain</subject><subj-group><subject>Somatosensory Cortex</subject></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Medicine and Health Sciences</subject><subj-group><subject>Anatomy</subject><subj-group><subject>Brain</subject><subj-group><subject>Somatosensory Cortex</subject></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Physical Sciences</subject><subj-group><subject>Mathematics</subject><subj-group><subject>Applied Mathematics</subject><subj-group><subject>Finite Element Analysis</subject></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Biology and Life Sciences</subject><subj-group><subject>Cell Biology</subject><subj-group><subject>Signal Transduction</subject><subj-group><subject>Cell Signaling</subject><subj-group><subject>Membrane Receptor Signaling</subject></subj-group></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Biology and Life Sciences</subject><subj-group><subject>Anatomy</subject><subj-group><subject>Brain</subject><subj-group><subject>Hippocampus</subject></subj-group></subj-group></subj-group></subj-group><subj-group subj-group-type="Discipline-v3"><subject>Medicine and Health Sciences</subject><subj-group><subject>Anatomy</subject><subj-group><subject>Brain</subject><subj-group><subject>Hippocampus</subject></subj-group></subj-group></subj-group></subj-group></article-categories><title-group><article-title>BlueRecording: A pipeline for the efficient calculation of extracellular recordings in large-scale neural circuit models</article-title><alt-title alt-title-type="running-head">BlueRecording</alt-title></title-group><contrib-group><contrib contrib-type="author" corresp="yes"><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0002-2390-4104</contrib-id><name><surname>Tharayil</surname><given-names>Joseph James</given-names></name><role content-type="http://credit.niso.org/contributor-roles/conceptualization/">Conceptualization</role><role content-type="http://credit.niso.org/contributor-roles/formal analysis/">Formal analysis</role><role content-type="http://credit.niso.org/contributor-roles/investigation/">Investigation</role><role content-type="http://credit.niso.org/contributor-roles/methodology/">Methodology</role><role content-type="http://credit.niso.org/contributor-roles/software/">Software</role><role content-type="http://credit.niso.org/contributor-roles/validation/">Validation</role><role content-type="http://credit.niso.org/contributor-roles/visualization/">Visualization</role><role content-type="http://credit.niso.org/contributor-roles/writing-original-draft/">Writing &#x02013; original draft</role><role content-type="http://credit.niso.org/contributor-roles/writing-review-editing/">Writing &#x02013; review &#x00026; editing</role><xref rid="aff001" ref-type="aff">
<sup>1</sup>
</xref><xref rid="cor001" ref-type="corresp">*</xref></contrib><contrib contrib-type="author"><name><surname>Blanco Alonso</surname><given-names>Jorge</given-names></name><role content-type="http://credit.niso.org/contributor-roles/methodology/">Methodology</role><role content-type="http://credit.niso.org/contributor-roles/software/">Software</role><role content-type="http://credit.niso.org/contributor-roles/writing-original-draft/">Writing &#x02013; original draft</role><xref rid="aff001" ref-type="aff">
<sup>1</sup>
</xref></contrib><contrib contrib-type="author"><name><surname>Farcito</surname><given-names>Silvia</given-names></name><role content-type="http://credit.niso.org/contributor-roles/data-curation/">Data curation</role><xref rid="aff002" ref-type="aff">
<sup>2</sup>
</xref></contrib><contrib contrib-type="author"><name><surname>Lloyd</surname><given-names>Bryn</given-names></name><role content-type="http://credit.niso.org/contributor-roles/methodology/">Methodology</role><role content-type="http://credit.niso.org/contributor-roles/software/">Software</role><xref rid="aff002" ref-type="aff">
<sup>2</sup>
</xref></contrib><contrib contrib-type="author"><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0001-6388-4286</contrib-id><name><surname>Romani</surname><given-names>Armando</given-names></name><role content-type="http://credit.niso.org/contributor-roles/data-curation/">Data curation</role><role content-type="http://credit.niso.org/contributor-roles/visualization/">Visualization</role><xref rid="aff001" ref-type="aff">
<sup>1</sup>
</xref></contrib><contrib contrib-type="author"><name><surname>Boci</surname><given-names>Elvis</given-names></name><role content-type="http://credit.niso.org/contributor-roles/visualization/">Visualization</role><xref rid="aff001" ref-type="aff">
<sup>1</sup>
</xref></contrib><contrib contrib-type="author"><name><surname>Cassara</surname><given-names>Antonino</given-names></name><role content-type="http://credit.niso.org/contributor-roles/supervision/">Supervision</role><xref rid="aff002" ref-type="aff">
<sup>2</sup>
</xref></contrib><contrib contrib-type="author"><name><surname>Sch&#x000fc;rmann</surname><given-names>Felix</given-names></name><role content-type="http://credit.niso.org/contributor-roles/project-administration/">Project administration</role><role content-type="http://credit.niso.org/contributor-roles/resources/">Resources</role><role content-type="http://credit.niso.org/contributor-roles/supervision/">Supervision</role><xref rid="aff001" ref-type="aff">
<sup>1</sup>
</xref></contrib><contrib contrib-type="author"><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0001-5528-6147</contrib-id><name><surname>Neufeld</surname><given-names>Esra</given-names></name><role content-type="http://credit.niso.org/contributor-roles/conceptualization/">Conceptualization</role><role content-type="http://credit.niso.org/contributor-roles/methodology/">Methodology</role><role content-type="http://credit.niso.org/contributor-roles/project-administration/">Project administration</role><role content-type="http://credit.niso.org/contributor-roles/supervision/">Supervision</role><role content-type="http://credit.niso.org/contributor-roles/validation/">Validation</role><role content-type="http://credit.niso.org/contributor-roles/writing-review-editing/">Writing &#x02013; review &#x00026; editing</role><xref rid="aff002" ref-type="aff">
<sup>2</sup>
</xref></contrib><contrib contrib-type="author"><name><surname>Kuster</surname><given-names>Niels</given-names></name><role content-type="http://credit.niso.org/contributor-roles/funding-acquisition/">Funding acquisition</role><role content-type="http://credit.niso.org/contributor-roles/resources/">Resources</role><xref rid="aff002" ref-type="aff">
<sup>2</sup>
</xref></contrib><contrib contrib-type="author"><name><surname>Reimann</surname><given-names>Michael</given-names></name><role content-type="http://credit.niso.org/contributor-roles/conceptualization/">Conceptualization</role><role content-type="http://credit.niso.org/contributor-roles/methodology/">Methodology</role><role content-type="http://credit.niso.org/contributor-roles/project-administration/">Project administration</role><role content-type="http://credit.niso.org/contributor-roles/software/">Software</role><role content-type="http://credit.niso.org/contributor-roles/writing-review-editing/">Writing &#x02013; review &#x00026; editing</role><xref rid="aff001" ref-type="aff">
<sup>1</sup>
</xref></contrib></contrib-group><aff id="aff001"><label>1</label>
<addr-line>Blue Brain Project, &#x000c9;cole polytechnique f&#x000e9;d&#x000e9;rale de Lausanne (EPFL) Campus Biotech, Geneva, Switzerland</addr-line></aff><aff id="aff002"><label>2</label>
<addr-line>Foundation for Research on Information Technologies in Society (IT&#x02019;IS), Zurich, Switzerland</addr-line></aff><contrib-group><contrib contrib-type="editor"><name><surname>Antol&#x000ed;k</surname><given-names>J&#x000e1;n</given-names></name><role>Editor</role><xref rid="edit1" ref-type="aff"/></contrib></contrib-group><aff id="edit1">
<addr-line>Centre National de la Recherche Scientifique, FRANCE</addr-line>
</aff><author-notes><fn fn-type="COI-statement" id="coi001"><p>The authors have declared that no competing interests exist.</p></fn><corresp id="cor001">* E-mail: <email>tharayiljoe@gmail.com</email></corresp></author-notes><pub-date pub-type="epub"><day>23</day><month>5</month><year>2025</year></pub-date><pub-date pub-type="collection"><month>5</month><year>2025</year></pub-date><volume>21</volume><issue>5</issue><elocation-id>e1013023</elocation-id><history><date date-type="received"><day>21</day><month>10</month><year>2024</year></date><date date-type="accepted"><day>3</day><month>4</month><year>2025</year></date></history><permissions><copyright-statement>&#x000a9; 2025 James Tharayil et al</copyright-statement><copyright-year>2025</copyright-year><copyright-holder>James Tharayil et al</copyright-holder><license><ali:license_ref xmlns:ali="http://www.niso.org/schemas/ali/1.0/" specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref><license-p>This is an open access article distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use, distribution, and reproduction in any medium, provided the original author and source are credited.</license-p></license></permissions><self-uri content-type="pdf" xlink:href="pcbi.1013023.pdf">
</self-uri><abstract><p>As the size and complexity of network simulations accessible to computational neuroscience grows, new avenues open for research into extracellularly recorded electric signals. Biophysically detailed simulations permit the identification of the biological origins of the different components of recorded signals, the evaluation of signal sensitivity to different anatomical, physiological, and geometric factors, and selection of recording parameters to maximize the signal information content. Simultaneously, virtual extracellular signals produced by these networks may become important metrics for neuro-simulation validation. To enable efficient calculation of extracellular signals from large neural network simulations, we have developed <italic toggle="yes">BlueRecording</italic>, a pipeline consisting of standalone Python code, along with extensions to the Neurodamus simulation control application, the CoreNEURON computation engine, and the SONATA data format, to permit online calculation of such signals. In particular, we implement a general form of the reciprocity theorem, which is capable of handling non-dipolar current sources, such as may be found in long axons and recordings close to the current source, as well as complex tissue anatomy, dielectric heterogeneity, and electrode geometries. To our knowledge, this is the first application of this generalized (i.e., non-dipolar) reciprocity-based approach to simulate EEG recordings. We use these tools to calculate extracellular signals from an <italic toggle="yes">in silico</italic> model of the rat somatosensory cortex and hippocampus and to study signal contribution differences between regions and cell types.</p></abstract><abstract abstract-type="summary"><title>Author summary</title><p>In this paper, we introduce <italic toggle="yes">BlueRecording</italic>, a suite of software tools that enables the simulation of extracellular recordings from large-scale neural circuit models. With BlueRecording, users can simulate EEG, ECoG, and intracellular recordings, using a variety of signal estimation methods. Notably, BlueRecording implements the innovative &#x0201c;generalized reciprocity approach&#x0201d;, which allows the accurate calculation of signals with arbitrarily complex electrode shapes and arrangements and heterogeneous, anisotropic head models. BlueRecording is tightly integrated into the CoreNEURON simulation engine, leading to a 3-fold improvement in computation time compared to the state-of-the-art. It is compatible with the SONATA format for neural circuit models; as demonstrators, we compute signals from <italic toggle="yes">in silico</italic> models of the rat somatosensory cortex and of the hippocampus using BlueRecording, which permits us to disambiguate the contributions of different cell types to the EEG signal.</p></abstract><funding-group><award-group id="award001"><funding-source>
<institution-wrap><institution-id institution-id-type="funder-id">http://dx.doi.org/10.13039/501100020899</institution-id><institution>Board of the Swiss Federal Institutes of Technology</institution></institution-wrap>
</funding-source></award-group><funding-statement>This work was supported by funding to the Blue Brain Project, a research center of the &#x000c9;cole polytechnique f&#x000e9;d&#x000e9;rale de Lausanne (EPFL), from the Swiss government&#x02019;s ETH Board of the Swiss Federal Institutes of Technology. The funders had no role in study design, data collection and analysis, decision to publish, or preparation of the manuscript.</funding-statement></funding-group><counts><fig-count count="7"/><table-count count="4"/><page-count count="25"/></counts><custom-meta-group><custom-meta id="data-availability"><meta-name>Data Availability</meta-name><meta-value>The seven column subvolume of the BBP circuit model is available on Zenodo under the following DOI: <ext-link xlink:href="https://doi.org/10.5281/zenodo.11113043" ext-link-type="uri">https://doi.org/10.5281/zenodo.11113043</ext-link> The full BBP circuit model is available on Harvard Dataverse under the following DOI:<ext-link xlink:href="https://doi.org/10.7910/DVN/HISHXN" ext-link-type="uri">https://doi.org/10.7910/DVN/HISHXN</ext-link>The hippocampus model is available on Harvard Dataverse under the following DOI:<ext-link xlink:href="https://doi.org/10.7910/DVN/TN3DUI" ext-link-type="uri">https://doi.org/10.7910/DVN/TN3DUI</ext-link> Membrane mechanism files used in the neuro-simulations are available at <ext-link xlink:href="https://github.com/BlueBrain/neurodamus-models" ext-link-type="uri">https://github.com/BlueBrain/neurodamus-models</ext-link> The specification for the version of the SONATA format used at BBP is available at <ext-link xlink:href="https://github.com/BlueBrain/sonata-extension" ext-link-type="uri">https://github.com/BlueBrain/sonata-extension</ext-link>. Source code for Neurodamus is available at <ext-link xlink:href="https://github.com/BlueBrain/neurodamus" ext-link-type="uri">https://github.com/BlueBrain/neurodamus</ext-link> CoreNEURON itself is fully integrated into the NEURON simulation environment, which is available at <ext-link xlink:href="https://github.com/neuronsimulator/nrn" ext-link-type="uri">https://github.com/neuronsimulator/nrn </ext-link> Code for the generation of FEM models, as well as a list of dependencies, is available at <ext-link xlink:href="https://github.com/BlueBrain/BlueBrainHeadModels" ext-link-type="uri">https://github.com/BlueBrain/BlueBrainHeadModels</ext-link> The input files required for the generation of the FEM meshes are available on Zeonodo <ext-link xlink:href="https://doi.org/10.5281/zenodo.10926947" ext-link-type="uri">https://doi.org/10.5281/zenodo.1092694</ext-link> The final finite element meshes and FEM output files used in the simulations in Sect 3 are available on Zenodo <ext-link xlink:href="https://doi.org/10.5281/zenodo.14419388" ext-link-type="uri">https://doi.org/10.5281/zenodo.14419388</ext-link>
</meta-value></custom-meta></custom-meta-group></article-meta><notes><title>Data Availability</title><p>The seven column subvolume of the BBP circuit model is available on Zenodo under the following DOI: <ext-link xlink:href="https://doi.org/10.5281/zenodo.11113043" ext-link-type="uri">https://doi.org/10.5281/zenodo.11113043</ext-link> The full BBP circuit model is available on Harvard Dataverse under the following DOI:<ext-link xlink:href="https://doi.org/10.7910/DVN/HISHXN" ext-link-type="uri">https://doi.org/10.7910/DVN/HISHXN</ext-link>The hippocampus model is available on Harvard Dataverse under the following DOI:<ext-link xlink:href="https://doi.org/10.7910/DVN/TN3DUI" ext-link-type="uri">https://doi.org/10.7910/DVN/TN3DUI</ext-link> Membrane mechanism files used in the neuro-simulations are available at <ext-link xlink:href="https://github.com/BlueBrain/neurodamus-models" ext-link-type="uri">https://github.com/BlueBrain/neurodamus-models</ext-link> The specification for the version of the SONATA format used at BBP is available at <ext-link xlink:href="https://github.com/BlueBrain/sonata-extension" ext-link-type="uri">https://github.com/BlueBrain/sonata-extension</ext-link>. Source code for Neurodamus is available at <ext-link xlink:href="https://github.com/BlueBrain/neurodamus" ext-link-type="uri">https://github.com/BlueBrain/neurodamus</ext-link> CoreNEURON itself is fully integrated into the NEURON simulation environment, which is available at <ext-link xlink:href="https://github.com/neuronsimulator/nrn" ext-link-type="uri">https://github.com/neuronsimulator/nrn </ext-link> Code for the generation of FEM models, as well as a list of dependencies, is available at <ext-link xlink:href="https://github.com/BlueBrain/BlueBrainHeadModels" ext-link-type="uri">https://github.com/BlueBrain/BlueBrainHeadModels</ext-link> The input files required for the generation of the FEM meshes are available on Zeonodo <ext-link xlink:href="https://doi.org/10.5281/zenodo.10926947" ext-link-type="uri">https://doi.org/10.5281/zenodo.1092694</ext-link> The final finite element meshes and FEM output files used in the simulations in Sect 3 are available on Zenodo <ext-link xlink:href="https://doi.org/10.5281/zenodo.14419388" ext-link-type="uri">https://doi.org/10.5281/zenodo.14419388</ext-link>
</p></notes></front><body><sec sec-type="intro" id="sec001"><title>1. Introduction</title><p>The source of key signals measured in neuroscience is the transmembrane current generated by the electrical activity of neurons. Computational investigation of such signals using compartmental models requires: (1) a model and simulator that calculate the membrane currents, and (2) an estimation of how each compartment&#x02019;s current affects the signal. For (2), typically simplifying approaches have been used. Simply comparing model output to reconstructed current dipoles relies on accurate and reliable source reconstruction from EEG data using inverse solution methods [<xref rid="pcbi.1013023.ref001" ref-type="bibr">1</xref>] &#x02013; something that is difficult to achieve because of the poorly conditioned inverse problem and the complex impact of volume conduction in the heterogeneous head anatomy on EEG signal formation. Point-source and line-source approaches approximate the properties of the different tissues as homogeneous [<xref rid="pcbi.1013023.ref002" ref-type="bibr">2</xref>&#x02013;<xref rid="pcbi.1013023.ref004" ref-type="bibr">4</xref>]. They are therefore only valid where electrodes are within the brain tissue, where some degree of homogeneity of the nearby dielectric environment can be assumed. The commonly employed simplified variant of the reciprocity theorem approximates individual neurons or groups of neurons as dipolar sources. It is therefore only valid when electrodes are sufficiently far away from said neurons [<xref rid="pcbi.1013023.ref005" ref-type="bibr">5</xref>].</p><p>Our goals in this work were to: provide a solution to (2) that is equally valid for both proximal and distal electrical measurements; provide flexibility to researchers with respect to the approaches to both (1) and (2) they want to employ; and to support very large electrophysiological models by enabling online and efficient computation.</p><p>We use the general form of the reciprocity theorem developed by Plonsey [<xref rid="pcbi.1013023.ref006" ref-type="bibr">6</xref>], which supports full compartmental resolution of the neuronal models and takes into account the dielectric properties of all tissues, to calculate the impact of each compartment on the signal. It can be employed for EEG, ECoG and LFP, and is capable of dealing with arbitrarily shaped electrode geometries. The impact of each compartment on the signal is stored in what we call a weights file. We then implemented extensions to the Neurodamus simulation control software [<xref rid="pcbi.1013023.ref007" ref-type="bibr">7</xref>] and the CoreNEURON simulation engine [<xref rid="pcbi.1013023.ref008" ref-type="bibr">8</xref>] to consume a weights file to calculate the signal during a simulation run and store the result for later analysis. Together, we call the applications to calculate weights files and the extensions to the simulator the BlueRecording framework.</p><p>The formalism of a standardized weights file ensures flexibility with respect to objective (2). A user can easily implement a different solution so long as it provides a valid weights file. Since large-scale simulations are required for the EEG signal, the ability to use the highly efficient CoreNEURON simulation engine regardless of dielectric model is a significant advantage. In addition, BlueRecording is compatible with any circuit defined in the SONATA format [<xref rid="pcbi.1013023.ref009" ref-type="bibr">9</xref>], making it easily portable between different simulators, and therefore highly flexible with respect to objective (1) as well.</p><p>In this paper, we apply BlueRecording to microcircuit models developed by the Blue Brain Project (BBP). The BBP somatosensory cortex model consists of <inline-formula id="pcbi.1013023.e001"><alternatives><graphic xlink:href="pcbi.1013023.e001.jpg" id="pcbi.1013023.e001g" position="anchor"/><mml:math id="M1" display="inline" overflow="scroll"><mml:mrow><mml:mi>~</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>4.2 million reconstructed neurons with accurate morphologies, optimized physiological properties, and algorithmically generated connectivity [<xref rid="pcbi.1013023.ref010" ref-type="bibr">10</xref>]. The BBP hippocampus CA1 model consists of <inline-formula id="pcbi.1013023.e002"><alternatives><graphic xlink:href="pcbi.1013023.e002.jpg" id="pcbi.1013023.e002g" position="anchor"/><mml:math id="M2" display="inline" overflow="scroll"><mml:mrow><mml:mi>~</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>456,000 mophologically detailed neurons, with properties and connectivity generated in a similar manner to [<xref rid="pcbi.1013023.ref010" ref-type="bibr">10</xref>], along with virtual innervation by Schafer collaterals and cholinergic modulation [<xref rid="pcbi.1013023.ref011" ref-type="bibr">11</xref>]. The support for spatially extended and morphologically highly detailed BBP microcircuits is a particular advantage when studying EEG signals. This is demonstrated here by comparing virtual LFP, EEG, and ECoG, and identifying various contributions to the signals.</p></sec><sec sec-type="materials|methods" id="sec002"><title>2. Design and implementation</title><p>The extracellular signals are calculated online in the NEURON simulation environment. Due to the linear nature of Maxwell&#x02019;s equation, the signal at a particular electrode (relative to another electrode or ground) is amenable to the form</p><disp-formula id="pcbi.1013023.e003"><alternatives><graphic xlink:href="pcbi.1013023.e003.jpg" id="pcbi.1013023.e003g" position="anchor"/><mml:math id="M3" display="block" overflow="scroll"><mml:mrow><mml:mrow><mml:mi>V</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msubsup><mml:mi>&#x003a3;</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>m</mml:mi></mml:msubsup><mml:msubsup><mml:mi>&#x003a3;</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>n</mml:mi></mml:msubsup><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mtext mathvariant="monospace">i_membrane</mml:mtext><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives>
<label>(1)</label></disp-formula><p>where <inline-formula id="pcbi.1013023.e004"><alternatives><graphic xlink:href="pcbi.1013023.e004.jpg" id="pcbi.1013023.e004g" position="anchor"/><mml:math id="M4" display="inline" overflow="scroll"><mml:mrow><mml:mtext mathvariant="monospace">i\_membrane</mml:mtext></mml:mrow></mml:math></alternatives></inline-formula> is the total compartmental transmembrane current (i.e., the sum of the ionic and capacitive currents, as described in [<xref rid="pcbi.1013023.ref002" ref-type="bibr">2</xref>]), <italic toggle="yes">i</italic> is the index of each neuron in the circuit, <italic toggle="yes">j</italic> is the index of each neural compartment in the neuron, and <italic toggle="yes">C</italic> is a scaling factor (&#x02018;weight&#x02019;), the calculation of which is discussed below. The equation takes the form of the commonly employed lead-field matrices [<xref rid="pcbi.1013023.ref012" ref-type="bibr">12</xref>], which are frequently applied to dipole source distributions, but have also been applied directly to transmembrane currents [<xref rid="pcbi.1013023.ref013" ref-type="bibr">13</xref>&#x02013;<xref rid="pcbi.1013023.ref017" ref-type="bibr">17</xref>]. The simulator supports simultaneous recording from an arbitrary number of electrodes.</p><sec id="sec003"><title>2.1. Calculation of coefficients</title><sec id="sec004"><title>2.1.1. Generalized reciprocity approach.</title><p>BlueRecording permits the calculation of extracellular signals using the reciprocity theorem [<xref rid="pcbi.1013023.ref006" ref-type="bibr">6</xref>]. The reciprocity theorem establishes a simple relationship between the electric field induced at different locations in the brain by applying a current through two surface electrodes, and the voltage difference measured between these electrodes when placing a current source at the same brain locations. Intuitively, if a source at location A produces a voltage at location B, a source at location B will produce an identical voltage at location A &#x02013; hence the term &#x0201c;reciprocity&#x0201d;. As a result, measurable signals from distributed and dynamic brain activity can be computed using a single electromagnetic simulation, rather than needing a distinct simulation per independent source activity component.</p><p>More formally, following Plonsey [<xref rid="pcbi.1013023.ref006" ref-type="bibr">6</xref>],let us suppose that we have a a volume current source <italic toggle="yes">I</italic><sub><italic toggle="yes">U</italic></sub>(<italic toggle="yes">t</italic>) in an arbitrary dielectric environment <italic toggle="yes">U</italic> (in the case of a neural current source, <italic toggle="yes">I</italic><sub><italic toggle="yes">U</italic></sub>(<italic toggle="yes">t</italic>) is the set of neural segment currents <inline-formula id="pcbi.1013023.e005"><alternatives><graphic xlink:href="pcbi.1013023.e005.jpg" id="pcbi.1013023.e005g" position="anchor"/><mml:math id="M5" display="inline" overflow="scroll"><mml:mrow><mml:mo stretchy="false">{</mml:mo><mml:msub><mml:mtext mathvariant="monospace">i_membrane</mml:mtext><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mspace width="0.278em"/><mml:mo>&#x02200;</mml:mo><mml:mspace width="0.278em"/><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:math></alternatives></inline-formula>, where <italic toggle="yes">i</italic> is the index of each neuron and <italic toggle="yes">j</italic> is the index of each segment within a neuron). Further, let <inline-formula id="pcbi.1013023.e006"><alternatives><graphic xlink:href="pcbi.1013023.e006.jpg" id="pcbi.1013023.e006g" position="anchor"/><mml:math id="M6" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula> be the potential field resulting from that current source <italic toggle="yes">I</italic><sub><italic toggle="yes">U</italic></sub>(<italic toggle="yes">t</italic>). Now, suppose that instead of a volume current source, we have a surface current distribution <italic toggle="yes">K</italic> on the surface of the environment <italic toggle="yes">U</italic>. Let <inline-formula id="pcbi.1013023.e007"><alternatives><graphic xlink:href="pcbi.1013023.e007.jpg" id="pcbi.1013023.e007g" position="anchor"/><mml:math id="M7" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula> be the potential field resulting from <italic toggle="yes">K</italic>.</p><p>It can be shown (for a full derivation see [<xref rid="pcbi.1013023.ref006" ref-type="bibr">6</xref>]) that <inline-formula id="pcbi.1013023.e008"><alternatives><graphic xlink:href="pcbi.1013023.e008.jpg" id="pcbi.1013023.e008g" position="anchor"/><mml:math id="M8" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mo>&#x02230;</mml:mo><mml:mi>U</mml:mi></mml:msub><mml:msub><mml:mi>I</mml:mi><mml:mi>U</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mi>&#x000b7;</mml:mi><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mi>d</mml:mi><mml:mi>U</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mo>&#x0222f;</mml:mo><mml:mi>S</mml:mi></mml:msub><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mi>&#x000b7;</mml:mi><mml:mi>K</mml:mi><mml:mi>d</mml:mi><mml:mi>S</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>.</p><p>When <italic toggle="yes">K</italic> consists of a pair (<italic toggle="yes">a</italic>,<italic toggle="yes">b</italic>) of quasi-perfect electric conductors (e.g., metallic EEG electrodes) providing a (virtual) current <italic toggle="yes">J</italic>, the situation simplifies to <inline-formula id="pcbi.1013023.e009"><alternatives><graphic xlink:href="pcbi.1013023.e009.jpg" id="pcbi.1013023.e009g" position="anchor"/><mml:math id="M9" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mo>&#x02230;</mml:mo><mml:mi>U</mml:mi></mml:msub><mml:msub><mml:mi>I</mml:mi><mml:mi>U</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula>
<inline-formula id="pcbi.1013023.e010"><alternatives><graphic xlink:href="pcbi.1013023.e010.jpg" id="pcbi.1013023.e010g" position="anchor"/><mml:math id="M10" display="inline" overflow="scroll"><mml:mrow><mml:mi>&#x000b7;</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>
<inline-formula id="pcbi.1013023.e011"><alternatives><graphic xlink:href="pcbi.1013023.e011.jpg" id="pcbi.1013023.e011g" position="anchor"/><mml:math id="M11" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mi>d</mml:mi><mml:mi>U</mml:mi><mml:mo>=</mml:mo><mml:mi>J</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>
<inline-formula id="pcbi.1013023.e012"><alternatives><graphic xlink:href="pcbi.1013023.e012.jpg" id="pcbi.1013023.e012g" position="anchor"/><mml:math id="M12" display="inline" overflow="scroll"><mml:mrow><mml:mi>&#x000b7;</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>
<inline-formula id="pcbi.1013023.e013"><alternatives><graphic xlink:href="pcbi.1013023.e013.jpg" id="pcbi.1013023.e013g" position="anchor"/><mml:math id="M13" display="inline" overflow="scroll"><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>a</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>b</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mi>J</mml:mi><mml:mi>&#x000b7;</mml:mi><mml:mi>V</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula>, where <inline-formula id="pcbi.1013023.e014"><alternatives><graphic xlink:href="pcbi.1013023.e014.jpg" id="pcbi.1013023.e014g" position="anchor"/><mml:math id="M14" display="inline" overflow="scroll"><mml:mrow><mml:mi>V</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>a</mml:mi></mml:mrow></mml:msub><mml:mn>1</mml:mn><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>b</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></alternatives></inline-formula> corresponds to the measured signal.</p><p>For a neurite with electrodes sufficiently far away, we can treat each nodal current <inline-formula id="pcbi.1013023.e015"><alternatives><graphic xlink:href="pcbi.1013023.e015.jpg" id="pcbi.1013023.e015g" position="anchor"/><mml:math id="M15" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mtext mathvariant="monospace">i\_membrane</mml:mtext><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>&#x02208;</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>U</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula> as point current sources at points <inline-formula id="pcbi.1013023.e016"><alternatives><graphic xlink:href="pcbi.1013023.e016.jpg" id="pcbi.1013023.e016g" position="anchor"/><mml:math id="M16" display="inline" overflow="scroll"><mml:mrow><mml:mrow><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mn>1</mml:mn></mml:msub><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:math></alternatives></inline-formula>, respectively. Thus, the left side of the equation reduces to <inline-formula id="pcbi.1013023.e017"><alternatives><graphic xlink:href="pcbi.1013023.e017.jpg" id="pcbi.1013023.e017g" position="anchor"/><mml:math id="M17" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mi>&#x003a3;</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>m</mml:mi></mml:msubsup><mml:msubsup><mml:mi>&#x003a3;</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>n</mml:mi></mml:msubsup><mml:msub><mml:mtext mathvariant="monospace">i\_membrane</mml:mtext><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula> and the potential between the two electrodes in this situation becomes</p><disp-formula id="pcbi.1013023.e018"><alternatives><graphic xlink:href="pcbi.1013023.e018.jpg" id="pcbi.1013023.e018g" position="anchor"/><mml:math id="M18" display="block" overflow="scroll"><mml:mrow><mml:mi>V</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover accent="true"><mml:mi>r</mml:mi><mml:mo>&#x02192;</mml:mo></mml:mover><mml:mi>a</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover accent="true"><mml:mi>r</mml:mi><mml:mo>&#x02192;</mml:mo></mml:mover><mml:mi>b</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>&#x003a3;</mml:mi><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:msup><mml:mn>1</mml:mn><mml:mi>m</mml:mi></mml:msup><mml:msubsup><mml:mi>&#x003a3;</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>n</mml:mi></mml:msubsup><mml:mi>i</mml:mi><mml:mo>_</mml:mo><mml:mi>m</mml:mi><mml:mi>e</mml:mi><mml:mi>m</mml:mi><mml:mi>b</mml:mi><mml:mi>r</mml:mi><mml:mi>a</mml:mi><mml:mi>n</mml:mi><mml:mi>e</mml:mi><mml:mo>_</mml:mo><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover accent="true"><mml:mi>r</mml:mi><mml:mo>&#x02192;</mml:mo></mml:mover><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>J</mml:mi></mml:mfrac></mml:mrow></mml:math></alternatives>
<label>(2)</label></disp-formula><p>The coefficients <italic toggle="yes">C</italic><sub><italic toggle="yes">j</italic></sub> used to calculate the extracellular signal as described in <xref rid="pcbi.1013023.e003" ref-type="disp-formula">Eq 1</xref> are therefore given by</p><disp-formula id="pcbi.1013023.e019"><alternatives><graphic xlink:href="pcbi.1013023.e019.jpg" id="pcbi.1013023.e019g" position="anchor"/><mml:math id="M19" display="block" overflow="scroll"><mml:mrow><mml:mrow><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>J</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mrow></mml:math></alternatives>
<label>(3)</label></disp-formula><p>In order to calculate <inline-formula id="pcbi.1013023.e020"><alternatives><graphic xlink:href="pcbi.1013023.e020.jpg" id="pcbi.1013023.e020g" position="anchor"/><mml:math id="M20" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula>, a finite element method (FEM) simulation of a head model with a recording electrode array is performed, where a (virtual) current is applied between a pair of recording electrodes, and the potential field is interpolated at the locations of the neural segments <inline-formula id="pcbi.1013023.e021"><alternatives><graphic xlink:href="pcbi.1013023.e021.jpg" id="pcbi.1013023.e021g" position="anchor"/><mml:math id="M21" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></alternatives></inline-formula>. Information about the FEM rat head model setups created for this study is provided in <xref rid="pcbi.1013023.s001" ref-type="supplementary-material">S1 Methods</xref>.</p></sec><sec id="sec005"><title>2.1.2. Dipole-based reciprocity approach.</title><p>If, for each neuron <italic toggle="yes">i</italic>, we take the Taylor series expansion of <inline-formula id="pcbi.1013023.e022"><alternatives><graphic xlink:href="pcbi.1013023.e022.jpg" id="pcbi.1013023.e022g" position="anchor"/><mml:math id="M22" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula> around the vector <inline-formula id="pcbi.1013023.e023"><alternatives><graphic xlink:href="pcbi.1013023.e023.jpg" id="pcbi.1013023.e023g" position="anchor"/><mml:math id="M23" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></alternatives></inline-formula> &#x02013; the geometric center of the neuron &#x02013; we obtain, to first order</p><disp-formula id="pcbi.1013023.e024"><alternatives><graphic xlink:href="pcbi.1013023.e024.jpg" id="pcbi.1013023.e024g" position="anchor"/><mml:math id="M24" display="block" overflow="scroll"><mml:mrow><mml:mrow><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>&#x02248;</mml:mo><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mo>&#x02207;</mml:mo><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mi>&#x000b7;</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives>
<label>(4)</label></disp-formula><p>Substitution <xref rid="pcbi.1013023.e024" ref-type="disp-formula">Eq 4</xref> into <xref rid="pcbi.1013023.e018" ref-type="disp-formula">Eq 2</xref> and rearranging, we obtain</p><disp-formula id="pcbi.1013023.e025"><alternatives><graphic xlink:href="pcbi.1013023.e025.jpg" id="pcbi.1013023.e025g" position="anchor"/><mml:math id="M25" display="block" overflow="scroll"><mml:mrow><mml:mrow><mml:mi>J</mml:mi><mml:mi>&#x000b7;</mml:mi><mml:mi>V</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>&#x02248;</mml:mo><mml:msubsup><mml:mi>&#x003a3;</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>m</mml:mi></mml:msubsup><mml:mo stretchy="false">[</mml:mo><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>&#x003a3;</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:msub><mml:mtext mathvariant="monospace">i_membrane</mml:mtext><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:msub><mml:mi>&#x003a3;</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:msub><mml:mtext mathvariant="monospace">i_membrane</mml:mtext><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>&#x02207;</mml:mo><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mi>&#x000b7;</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mi>j</mml:mi></mml:msub><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">]</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives>
<label>(5)</label></disp-formula><p>For a neural current source, <inline-formula id="pcbi.1013023.e026"><alternatives><graphic xlink:href="pcbi.1013023.e026.jpg" id="pcbi.1013023.e026g" position="anchor"/><mml:math id="M26" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mi>&#x003a3;</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:msub><mml:mtext mathvariant="monospace">i_membrane</mml:mtext><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></alternatives></inline-formula> by Kirchhoff&#x02019;s Law. Thus,</p><disp-formula id="pcbi.1013023.e027"><alternatives><graphic xlink:href="pcbi.1013023.e027.jpg" id="pcbi.1013023.e027g" position="anchor"/><mml:math id="M27" display="block" overflow="scroll"><mml:mrow><mml:mrow><mml:mi>V</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>&#x02248;</mml:mo><mml:msub><mml:mi>&#x003a3;</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mfrac><mml:mrow><mml:mo>&#x02207;</mml:mo><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mi>&#x000b7;</mml:mi><mml:msub><mml:mover><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>J</mml:mi></mml:mrow></mml:mfrac></mml:mstyle><mml:mo>=</mml:mo><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mi>&#x003a3;</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mover><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mi>&#x000b7;</mml:mi><mml:msub><mml:mover><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives>
<label>(6)</label></disp-formula><p>where <inline-formula id="pcbi.1013023.e028"><alternatives><graphic xlink:href="pcbi.1013023.e028.jpg" id="pcbi.1013023.e028g" position="anchor"/><mml:math id="M28" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mover><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula> is the current dipole calculated for neuron <italic toggle="yes">i</italic> at each time step as</p><disp-formula id="pcbi.1013023.e029"><alternatives><graphic xlink:href="pcbi.1013023.e029.jpg" id="pcbi.1013023.e029g" position="anchor"/><mml:math id="M29" display="block" overflow="scroll"><mml:mrow><mml:mrow><mml:msub><mml:mover><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msub><mml:mi>&#x003a3;</mml:mi><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mtext mathvariant="monospace">i_membrane</mml:mtext><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mi>&#x000b7;</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives>
<label>(7)</label></disp-formula><p>The normalized <inline-formula id="pcbi.1013023.e030"><alternatives><graphic xlink:href="pcbi.1013023.e030.jpg" id="pcbi.1013023.e030g" position="anchor"/><mml:math id="M30" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mover><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mo>&#x02212;</mml:mo><mml:mo>&#x02207;</mml:mo><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>/</mml:mo><mml:mi>J</mml:mi></mml:mrow></mml:math></alternatives></inline-formula> is the &#x02018;lead-field&#x02019;. <inline-formula id="pcbi.1013023.e031"><alternatives><graphic xlink:href="pcbi.1013023.e031.jpg" id="pcbi.1013023.e031g" position="anchor"/><mml:math id="M31" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mover><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub></mml:mrow></mml:math></alternatives></inline-formula> can be computed using a FEM model, as described in <xref rid="pcbi.1013023.s001" ref-type="supplementary-material">S1 Methods</xref>, and is interpolated at the geometric center of each neuron, <inline-formula id="pcbi.1013023.e032"><alternatives><graphic xlink:href="pcbi.1013023.e032.jpg" id="pcbi.1013023.e032g" position="anchor"/><mml:math id="M32" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></alternatives></inline-formula>. Substituting into <xref rid="pcbi.1013023.e003" ref-type="disp-formula">Eq 1</xref> and rearranging, we find that</p><disp-formula id="pcbi.1013023.e033"><alternatives><graphic xlink:href="pcbi.1013023.e033.jpg" id="pcbi.1013023.e033g" position="anchor"/><mml:math id="M33" display="block" overflow="scroll"><mml:mrow><mml:mrow><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mi>n</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mi>&#x000b7;</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives>
<label>(8)</label></disp-formula><p>While the choice of <inline-formula id="pcbi.1013023.e034"><alternatives><graphic xlink:href="pcbi.1013023.e034.jpg" id="pcbi.1013023.e034g" position="anchor"/><mml:math id="M34" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></alternatives></inline-formula> is not relevant from an analytical perspective, it can be numerically advantageous to place it near the neuron center.</p></sec><sec id="sec006"><title>2.1.3. Calculation of coefficients with line-source approximation.</title><p>Unlike EEG or ECoG electrodes, LFP electrodes are small and located within the cortical tissue. If the LFP electrode can be treated as point-like, the tissue within the relevant environment is homogeneous and isotropic, and the ground reference sufficiently distant to be treated as being at infinity and omnidirectional, the computation of an &#x02018;exposing&#x02019; potential required by the reciprocity theorem can be avoided and instead the line-source approximation can be used to compute the coefficients for LFP calculations without need for FEM simulation.</p><p>According to the line-source approximation [<xref rid="pcbi.1013023.ref018" ref-type="bibr">18</xref>], the contribution to the electric potential at a point electrode location of a neural segment situated in a homogeneous, isotropic environment is given by <inline-formula id="pcbi.1013023.e035"><alternatives><graphic xlink:href="pcbi.1013023.e035.jpg" id="pcbi.1013023.e035g" position="anchor"/><mml:math id="M35" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mn>4</mml:mn><mml:mi>&#x003c0;</mml:mi><mml:msub><mml:mi>&#x003c3;</mml:mi><mml:mi>e</mml:mi></mml:msub><mml:msub><mml:mi>&#x00394;</mml:mi><mml:mi>s</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:mstyle displaystyle="true"><mml:munderover><mml:mo>&#x0222b;</mml:mo><mml:mrow><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mi>&#x00394;</mml:mi><mml:mi>s</mml:mi></mml:msub></mml:mrow><mml:mn>0</mml:mn></mml:munderover></mml:mstyle><mml:mfrac><mml:mrow><mml:msub><mml:mtext mathvariant="monospace">i_membrane</mml:mtext><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mi>&#x000b7;</mml:mi><mml:mi>d</mml:mi><mml:mi>s</mml:mi></mml:mrow><mml:mrow><mml:msqrt><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>h</mml:mi><mml:mo>&#x02212;</mml:mo><mml:mi>s</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mrow/><mml:mn>2</mml:mn><mml:mo>+</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:msqrt></mml:mrow></mml:mfrac></mml:mrow></mml:math></alternatives></inline-formula>, where <inline-formula id="pcbi.1013023.e036"><alternatives><graphic xlink:href="pcbi.1013023.e036.jpg" id="pcbi.1013023.e036g" position="anchor"/><mml:math id="M36" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mi>&#x00394;</mml:mi><mml:mi>s</mml:mi></mml:msub></mml:mrow></mml:math></alternatives></inline-formula> is the length of the segment, <italic toggle="yes">h</italic> is the distance from the near end of the segment to the recording electrode in the axial direction, and <italic toggle="yes">r</italic> is the absolute value of the distance from the near end of the segment to the electrode in the perpendicular direction. Evaluating the integral analytically and substituting into <xref rid="pcbi.1013023.e003" ref-type="disp-formula">Eq 1</xref>, we find that:</p><disp-formula id="pcbi.1013023.e037"><alternatives><graphic xlink:href="pcbi.1013023.e037.jpg" id="pcbi.1013023.e037g" position="anchor"/><mml:math id="M37" display="block" overflow="scroll"><mml:mrow><mml:mrow><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mn>4</mml:mn><mml:mi>&#x003c0;</mml:mi><mml:msub><mml:mi>&#x003c3;</mml:mi><mml:mi>e</mml:mi></mml:msub><mml:msub><mml:mi>&#x00394;</mml:mi><mml:mi>s</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:mrow><mml:mo fence="true" form="prefix" stretchy="true">{</mml:mo><mml:mtable><mml:mtr><mml:mtd columnalign="left"><mml:mi>l</mml:mi><mml:mi>o</mml:mi><mml:mi>g</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mfrac><mml:mrow><mml:msqrt><mml:mrow><mml:msup><mml:mi>h</mml:mi><mml:mn>2</mml:mn></mml:msup><mml:mo>+</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:msqrt><mml:mo>&#x02212;</mml:mo><mml:mi>h</mml:mi></mml:mrow><mml:mrow><mml:msqrt><mml:mrow><mml:msup><mml:mi>l</mml:mi><mml:mn>2</mml:mn></mml:msup><mml:mo>+</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:msqrt><mml:mo>&#x02212;</mml:mo><mml:mi>l</mml:mi></mml:mrow></mml:mfrac><mml:mo stretchy="false">)</mml:mo></mml:mtd><mml:mtd columnalign="left"><mml:mi>h</mml:mi><mml:mo>&#x0003c;</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mi>l</mml:mi><mml:mo>&#x0003c;</mml:mo><mml:mn>0</mml:mn></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mi>l</mml:mi><mml:mi>o</mml:mi><mml:mi>g</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mfrac><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msqrt><mml:mrow><mml:msup><mml:mi>h</mml:mi><mml:mn>2</mml:mn></mml:msup><mml:mo>+</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:msqrt><mml:mo>&#x02212;</mml:mo><mml:mi>h</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mi>l</mml:mi><mml:mo>+</mml:mo><mml:msqrt><mml:mrow><mml:msup><mml:mi>l</mml:mi><mml:mn>2</mml:mn></mml:msup><mml:mo>+</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:msqrt><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:msup><mml:mi>r</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac></mml:mtd><mml:mtd columnalign="left"><mml:mi>h</mml:mi><mml:mo>&#x0003c;</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mi>l</mml:mi><mml:mo>&#x0003e;</mml:mo><mml:mn>0</mml:mn></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mi>l</mml:mi><mml:mi>o</mml:mi><mml:mi>g</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mfrac><mml:mrow><mml:msqrt><mml:mrow><mml:msup><mml:mi>l</mml:mi><mml:mn>2</mml:mn></mml:msup><mml:mo>+</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:msqrt><mml:mo>+</mml:mo><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:msqrt><mml:mrow><mml:msup><mml:mi>h</mml:mi><mml:mn>2</mml:mn></mml:msup><mml:mo>+</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:msqrt><mml:mo>+</mml:mo><mml:mi>h</mml:mi></mml:mrow></mml:mfrac><mml:mo stretchy="false">)</mml:mo></mml:mtd><mml:mtd columnalign="left"><mml:mi>h</mml:mi><mml:mo>&#x0003e;</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mi>l</mml:mi><mml:mo>&#x0003e;</mml:mo><mml:mn>0</mml:mn></mml:mtd></mml:mtr></mml:mtable></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives>
<label>(9)</label></disp-formula><p>With <inline-formula id="pcbi.1013023.e038"><alternatives><graphic xlink:href="pcbi.1013023.e038.jpg" id="pcbi.1013023.e038g" position="anchor"/><mml:math id="M38" display="inline" overflow="scroll"><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>y</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>z</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula> and <inline-formula id="pcbi.1013023.e039"><alternatives><graphic xlink:href="pcbi.1013023.e039.jpg" id="pcbi.1013023.e039g" position="anchor"/><mml:math id="M39" display="inline" overflow="scroll"><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>y</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>z</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula> as the endpoints of the segment and (<italic toggle="yes">x</italic>,<italic toggle="yes">y</italic>,<italic toggle="yes">z</italic>) as the location of the electrode,</p><disp-formula id="pcbi.1013023.e040"><alternatives><graphic xlink:href="pcbi.1013023.e040.jpg" id="pcbi.1013023.e040g" position="anchor"/><mml:math id="M40" display="block" overflow="scroll"><mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mi>&#x00394;</mml:mi><mml:mi>s</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mi>y</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mi>z</mml:mi><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mi>z</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mi>&#x000b7;</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>y</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mi>y</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>z</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mi>z</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives>
<label>(10)</label></disp-formula><disp-formula id="pcbi.1013023.e041"><alternatives><graphic xlink:href="pcbi.1013023.e041.jpg" id="pcbi.1013023.e041g" position="anchor"/><mml:math id="M41" display="block" overflow="scroll"><mml:mrow><mml:mrow><mml:msup><mml:mi>r</mml:mi><mml:mn>2</mml:mn></mml:msup><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mn>2</mml:mn></mml:msup><mml:mo>+</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mi>y</mml:mi><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mi>y</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mn>2</mml:mn></mml:msup><mml:mo>+</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mi>z</mml:mi><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mi>z</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mn>2</mml:mn></mml:msup><mml:mo>&#x02212;</mml:mo><mml:msup><mml:mi>h</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mrow></mml:math></alternatives>
<label>(11)</label></disp-formula><disp-formula id="pcbi.1013023.e042"><alternatives><graphic xlink:href="pcbi.1013023.e042.jpg" id="pcbi.1013023.e042g" position="anchor"/><mml:math id="M42" display="block" overflow="scroll"><mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mo>=</mml:mo><mml:mi>h</mml:mi><mml:mo>+</mml:mo><mml:msub><mml:mi>&#x00394;</mml:mi><mml:mi>s</mml:mi></mml:msub></mml:mrow></mml:mrow></mml:math></alternatives>
<label>(12)</label></disp-formula></sec><sec id="sec007"><title>2.1.4. Calculation of coefficients with point-source approximation.</title><p>A further simplification can be made (in addition to the assumptions of an infinite homogeneous medium, a point-like electrode, and reference at infinity) by treating each neural compartment as a point rather than a line. In this case, the potential at the recording electrode is given by</p><disp-formula id="pcbi.1013023.e043"><alternatives><graphic xlink:href="pcbi.1013023.e043.jpg" id="pcbi.1013023.e043g" position="anchor"/><mml:math id="M43" display="block" overflow="scroll"><mml:mrow><mml:mrow><mml:mi>V</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mn>4</mml:mn><mml:mi>&#x003c0;</mml:mi><mml:msub><mml:mi>&#x003c3;</mml:mi><mml:mi>e</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:msub><mml:mi>&#x003a3;</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi>&#x003a3;</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mfrac><mml:mrow><mml:msub><mml:mtext mathvariant="monospace">i_membrane</mml:mtext><mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mi>e</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo></mml:mrow></mml:mfrac></mml:mrow></mml:mrow></mml:math></alternatives>
<label>(13)</label></disp-formula><p>where <inline-formula id="pcbi.1013023.e044"><alternatives><graphic xlink:href="pcbi.1013023.e044.jpg" id="pcbi.1013023.e044g" position="anchor"/><mml:math id="M44" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mi>e</mml:mi></mml:msub></mml:mrow></mml:math></alternatives></inline-formula> is the position of the electrode and <inline-formula id="pcbi.1013023.e045"><alternatives><graphic xlink:href="pcbi.1013023.e045.jpg" id="pcbi.1013023.e045g" position="anchor"/><mml:math id="M45" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></alternatives></inline-formula> is the position of the compartment. Substituting into <xref rid="pcbi.1013023.e003" ref-type="disp-formula">Eq 1</xref> we obtain:</p><disp-formula id="pcbi.1013023.e046"><alternatives><graphic xlink:href="pcbi.1013023.e046.jpg" id="pcbi.1013023.e046g" position="anchor"/><mml:math id="M46" display="block" overflow="scroll"><mml:mrow><mml:mrow><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mn>4</mml:mn><mml:mi>&#x003c0;</mml:mi><mml:msub><mml:mi>&#x003c3;</mml:mi><mml:mi>e</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>&#x02212;</mml:mo><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="true">&#x02192;</mml:mo></mml:mover><mml:mi>e</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo></mml:mrow></mml:mfrac></mml:mrow></mml:mrow></mml:math></alternatives>
<label>(14)</label></disp-formula></sec><sec id="sec008"><title>2.1.5. Choice of voltage and spatial reference.</title><p>The extracellular signals produced using the reciprocity approaches are gauge-independent with respect to the potential field (i.e., the location to which a potential of 0V is assigned is arbitrary). This is because the sum of membrane currents of the compartments over a neuron must be zero. Thus, any constant added to the compartment weights does not affect the signal, and only the difference in compartment weights matters. For better visualization, we can therefore add an offset to the compartment weights in each neuron such that the minimum weight per neuron is 0.</p></sec><sec id="sec009"><title>2.1.6. Numerical considerations.</title><p>Calculation of the extracellular signal involves summation over a large number of terms that typically compensate, potentially leading to important numerical errors as a large number of digits can be significant. Because of gauge freedom and current conservation, this can be mitigated by selecting good reference values for <inline-formula id="pcbi.1013023.e047"><alternatives><graphic xlink:href="pcbi.1013023.e047.jpg" id="pcbi.1013023.e047g" position="anchor"/><mml:math id="M47" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mover><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></alternatives></inline-formula> and <inline-formula id="pcbi.1013023.e048"><alternatives><graphic xlink:href="pcbi.1013023.e048.jpg" id="pcbi.1013023.e048g" position="anchor"/><mml:math id="M48" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mi>&#x003a6;</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:math></alternatives></inline-formula>, and if that proves insufficient, by using a compensation algorithm such as Kahan summation. Our implementation does not use Kahan summation, as we have not found it to be necessary for the current study. However, awareness that compensated summation might be required in other situations, is necessary.</p></sec></sec><sec id="sec010"><title>2.2. Workflow</title><p>The workflow for calculating coefficients and running an online extracellular recording simulation with BlueRecording is as follows (see as well <xref rid="pcbi.1013023.g001" ref-type="fig">Fig 1</xref>). Tools used for each step are listed in parentheses:</p><fig position="float" id="pcbi.1013023.g001"><object-id pub-id-type="doi">10.1371/journal.pcbi.1013023.g001</object-id><label>Fig 1</label><caption><title>Workflow for the BlueRecording Pipeline.</title><p>Input and output files are shown in red boxes, while processes are shown in black boxes. Dashed lines around the FEM simulation step indicate that it is only used for reciprocity-based calculations</p></caption><graphic xlink:href="pcbi.1013023.g001" position="float"/></fig><list list-type="order"><list-item><p><bold>Calculate Segment Positions:</bold> Segment positions are calculated in two steps<list list-type="roman-lower"><list-item><p><bold>Run Neuro-Simulation (Neurodamus):</bold> A minimal (at least one time step) neuro-simulation is run to produce a compartment report that reveals how the neurons are discretized.</p></list-item><list-item><p><bold>Interpolate segment positions (<monospace>bluerecording.getPositions.</monospace>
<monospace>getPositions()</monospace>):</bold> The compartment report and information from the simulation configuration file are used to interpolate the segment positions from the 3d coordinates in the morphology file, which are not necessarily aligned to the discretized compartments</p></list-item></list>
</p></list-item><list-item><p><bold>Create electrode csv file (Manual)</bold> See Sect 2.3.2</p></list-item><list-item><p><bold>Initialize Electrode Weights file (<monospace>bluerecording.writeH5</monospace>
<monospace>_prelim.initializeH5File()</monospace>):</bold> This step reads metadata from the electrode csv file and the discretization from the compartment report, and writes both to the weights file. See Sect 2.3.1 for details on the file format and 2.3.3 for details on writing the file</p></list-item><list-item><p><bold>Calculate weights:</bold><list list-type="roman-lower"><list-item><p><bold>Reciprocity-based methods</bold><list list-type="simple"><list-item><p>(i) <bold>FEM simulations (Any FEM solver):</bold> A FEM simulation is run to calculate the potential field generated by running a current between a recording electrode and a reference electrode. The results (see <xref rid="pcbi.1013023.s005" ref-type="supplementary-material">S1 Table</xref>) are exported.</p></list-item><list-item><p>(ii) <bold>Interpolation of weights (<monospace>bluerecording.writeH5.writeH5File()</monospace>):</bold> From the exported results, the weights are calculated by interpolating the potential field at the neural compartment locations (for the generalized reciprocity approach) or by taking the scalar product of the E field at the center of the neuron and the segment position vectors (for the dipole-reciprocity approach).</p></list-item></list>
</p></list-item><list-item><p><bold>Analytic calculations (<monospace>bluerecording.writeH5.writeH5File()</monospace>):</bold> For the line-source and point-source approximations, the weights are calculated analytically, without requiring FEM simulations.</p></list-item></list>
</p></list-item><list-item><p><bold>Run neuro-simulations (Neurodamus or alternative neuro-simulator)</bold> While it is intended that simulations be run using Neurodamus as described in Sect 2.3.4, other simulators may be extended to also support the weights file created in BlueRecording.</p></list-item></list></sec><sec id="sec011"><title>2.3. Implementation details</title><sec id="sec012"><title>2.3.1. Extension to SONATA-format.</title><p>We defined an extension to the SONATA format [<xref rid="pcbi.1013023.ref009" ref-type="bibr">9</xref>] to store the coefficients <italic toggle="yes">C</italic><sub><italic toggle="yes">i</italic>,<italic toggle="yes">j</italic></sub>. Briefly, the SONATA format treats each neuron in the network as a <bold>node</bold>, and nodes are organized into <bold>populations</bold>. The coefficients are stored in an HDF5 file (<xref rid="pcbi.1013023.t001" ref-type="table">Table 1</xref>), which also includes metadata on the type and location (both in Cartesian space and with respect to the anatomy) for each electrode. For each population, the coefficients for all nodes and all electrodes are listed in a single array; for each node, the coefficients (one per compartment) are listed consecutively. For each population, there is also a dataset listing the IDs of each node therein, as well as the index in the coefficient array at which the coefficients for that node begin.</p><table-wrap position="float" id="pcbi.1013023.t001"><object-id pub-id-type="doi">10.1371/journal.pcbi.1013023.t001</object-id><label>Table 1</label><caption><title>The format of the weights file</title></caption><alternatives><graphic xlink:href="pcbi.1013023.t001" id="pcbi.1013023.t001g" position="float"/><table frame="hsides" rules="groups"><colgroup span="1"><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/></colgroup><thead><tr><th align="left" rowspan="1" colspan="1">Group</th><th align="left" rowspan="1" colspan="1">Field</th><th align="left" rowspan="1" colspan="1">Type</th><th align="left" rowspan="1" colspan="1">Shape</th><th align="left" rowspan="1" colspan="1">Requirement</th><th align="left" rowspan="1" colspan="1">Description</th></tr></thead><tbody><tr><td align="left" rowspan="1" colspan="1"><p>/electrodes</p>
<p>/{<italic toggle="yes">electrodename</italic>}</p></td><td align="left" rowspan="1" colspan="1">layer</td><td align="left" rowspan="1" colspan="1">utf8</td><td align="left" rowspan="1" colspan="1">1</td><td align="left" rowspan="1" colspan="1">Optional</td><td align="left" rowspan="1" colspan="1">Layer of the circuit in which {<italic toggle="yes">electrodename</italic>} is located. If the electrode is in a region without cortical layers, then &#x0201c;NA&#x0201d;. If the electrode is outside the brain, then &#x0201c;Outside&#x0201d;</td></tr><tr><td align="left" rowspan="1" colspan="1"><p>/electrodes</p>
<p>/{<italic toggle="yes">electrodename</italic>}</p></td><td align="left" rowspan="1" colspan="1">position</td><td align="left" rowspan="1" colspan="1">float32</td><td align="left" rowspan="1" colspan="1">3</td><td align="left" rowspan="1" colspan="1">Mandatory</td><td align="left" rowspan="1" colspan="1">Position of {<italic toggle="yes">electrodename</italic>}, in cartesian coordinates [<inline-formula id="pcbi.1013023.e049"><alternatives><graphic xlink:href="pcbi.1013023.e049" id="pcbi.1013023.e049g" position="anchor"/><mml:math id="M49" display="inline" overflow="scroll"><mml:mrow><mml:mi>&#x003bc;</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>m]</td></tr><tr><td align="left" rowspan="1" colspan="1"><p>/electrodes</p>
<p>/{<italic toggle="yes">electrodename</italic>}</p></td><td align="left" rowspan="1" colspan="1">region</td><td align="left" rowspan="1" colspan="1">utf8</td><td align="left" rowspan="1" colspan="1">1</td><td align="left" rowspan="1" colspan="1">Optional</td><td align="left" rowspan="1" colspan="1">Region in which {<italic toggle="yes">electrodename</italic>} is located</td></tr><tr><td align="left" rowspan="1" colspan="1"><p>/electrodes</p>
<p>{<italic toggle="yes">electrodename</italic>}</p></td><td align="left" rowspan="1" colspan="1">type</td><td align="left" rowspan="1" colspan="1">utf8</td><td align="left" rowspan="1" colspan="1">1</td><td align="left" rowspan="1" colspan="1">Mandatory</td><td align="left" rowspan="1" colspan="1">Specifies the approach by which the coefficients are calculated. Takes the following values: Reciprocity, DipoleReciprocity, LineSource, or PointSource. Reciprocity refers to the equation from [<xref rid="pcbi.1013023.ref006" ref-type="bibr">6</xref>] for point sources of current. DipoleReciprocity is the simplified form of this equation for current dipole sources. LineSource means the analytic solution for current line sources in infinite, homogeneous extracellular media. PointSource refers to the analytic solution for point sources under the same simplified conditions.</td></tr><tr><td align="left" rowspan="1" colspan="1"><p>/electrodes</p>
<p>/{<italic toggle="yes">electrodename</italic>}/</p>
<p>{<italic toggle="yes">population_name</italic>}</p></td><td align="left" rowspan="1" colspan="1">electrode_id</td><td align="left" rowspan="1" colspan="1">uint64</td><td align="left" rowspan="1" colspan="1">1</td><td align="left" rowspan="1" colspan="1">Mandatory</td><td align="left" rowspan="1" colspan="1">Index of the column corresponding to this electrode in /electrodes/{population_name}/scaling_factors</td></tr><tr><td align="left" rowspan="1" colspan="1"><p>/electrodes</p>
<p>/{<italic toggle="yes">population_name</italic>}</p></td><td align="left" rowspan="1" colspan="1">scaling_factors</td><td align="left" rowspan="1" colspan="1">float64</td><td align="left" rowspan="1" colspan="1">Total_comp x N_elec+1</td><td align="left" rowspan="1" colspan="1">Mandatory</td><td align="left" rowspan="1" colspan="1">Scaling factor for each compartment in the corresponding neuron, in [V/nA]. All values in the last column are 1. This column corresponds to a &#x0201c;test electrode&#x0201d;. The signal from the test electrode should be <inline-formula id="pcbi.1013023.e050"><alternatives><graphic xlink:href="pcbi.1013023.e050" id="pcbi.1013023.e050g" position="anchor"/><mml:math id="M50" display="inline" overflow="scroll"><mml:mrow><mml:mi>~</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>0. If this is not the case, then the membrane currents over individual neurons do not sum to zero.</td></tr><tr><td align="left" rowspan="1" colspan="1">/{<italic toggle="yes">population_name</italic>}</td><td align="left" rowspan="1" colspan="1">node_ids</td><td align="left" rowspan="1" colspan="1">uint64</td><td align="left" rowspan="1" colspan="1">N_nodes</td><td align="left" rowspan="1" colspan="1">Mandatory</td><td align="left" rowspan="1" colspan="1">List of node ids. Node ids not listed here are to be ignored</td></tr><tr><td align="left" rowspan="1" colspan="1">/{<italic toggle="yes">population_name</italic>}</td><td align="left" rowspan="1" colspan="1">offsets</td><td align="left" rowspan="1" colspan="1">uint64</td><td align="left" rowspan="1" colspan="1">N_nodes + 1</td><td align="left" rowspan="1" colspan="1">Mandatory</td><td align="left" rowspan="1" colspan="1">The offset for each node in the scaling_factors field, followed by the index of the last element of the last node</td></tr></tbody></table></alternatives></table-wrap></sec><sec id="sec013"><title>2.3.2. Electrode array file format.</title><p>The electrode array for which the coefficients are calculated is defined in a csv file. The csv file begins with the header <monospace>name,x,y,z,</monospace>
<monospace>layer,region,type</monospace>. Each column of the file is described in <xref rid="pcbi.1013023.t002" ref-type="table">Table 2</xref>. Each row corresponds to an additional electrode. The electrode csv file is read when the weights file is created, in order to populate the metadata.</p><table-wrap position="float" id="pcbi.1013023.t002"><object-id pub-id-type="doi">10.1371/journal.pcbi.1013023.t002</object-id><label>Table 2</label><caption><title>The format of the electrode csv file</title></caption><alternatives><graphic xlink:href="pcbi.1013023.t002" id="pcbi.1013023.t002g" position="float"/><table frame="hsides" rules="groups"><colgroup span="1"><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/></colgroup><thead><tr><th align="left" rowspan="1" colspan="1">Entry</th><th align="left" rowspan="1" colspan="1">Description</th></tr></thead><tbody><tr><td align="left" rowspan="1" colspan="1">name</td><td align="left" rowspan="1" colspan="1">Either an index or a meaningful name describing the electrode</td></tr><tr><td align="left" rowspan="1" colspan="1">x</td><td align="left" rowspan="1" colspan="1">x-coordinate of the electrode (of the center of the electrode for extended electrode geometries), in <inline-formula id="pcbi.1013023.e051"><alternatives><graphic xlink:href="pcbi.1013023.e051" id="pcbi.1013023.e051g" position="anchor"/><mml:math id="M51" display="inline" overflow="scroll"><mml:mrow><mml:mi>&#x003bc;</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>m</td></tr><tr><td align="left" rowspan="1" colspan="1">y</td><td align="left" rowspan="1" colspan="1">y-coordinate of the electrode (of the center of the electrode for extended electrode geometries), in <inline-formula id="pcbi.1013023.e052"><alternatives><graphic xlink:href="pcbi.1013023.e052" id="pcbi.1013023.e052g" position="anchor"/><mml:math id="M52" display="inline" overflow="scroll"><mml:mrow><mml:mi>&#x003bc;</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>m</td></tr><tr><td align="left" rowspan="1" colspan="1">z</td><td align="left" rowspan="1" colspan="1">z-coordinate of the electrode (of the center of the electrode for extended electrode geometries), in <inline-formula id="pcbi.1013023.e053"><alternatives><graphic xlink:href="pcbi.1013023.e053" id="pcbi.1013023.e053g" position="anchor"/><mml:math id="M53" display="inline" overflow="scroll"><mml:mrow><mml:mi>&#x003bc;</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>m</td></tr><tr><td align="left" rowspan="1" colspan="1">layer</td><td align="left" rowspan="1" colspan="1">Cytological layer in which the electrode is located, or &#x0201c;NA&#x0201d; if in a brain region without layers, or &#x0201c;Outside&#x0201d; if not within the brain. Used only to provide reference information to the user.</td></tr><tr><td align="left" rowspan="1" colspan="1">region</td><td align="left" rowspan="1" colspan="1">Brain region in which the electrode is located, or &#x0201c;Outside&#x0201d; if not within the brain</td></tr><tr><td align="left" rowspan="1" colspan="1">type</td><td align="left" rowspan="1" colspan="1">Method used to calculate the weights (Reciprocity, DipoleReciprocity, PointSource, or LineSource)</td></tr></tbody></table></alternatives></table-wrap></sec><sec id="sec014"><title>2.3.3. Generation of weights files.</title><p>Discretization of the neurons into electrical compartments is performed at runtime. Therefore, to extract the number of compartments per neuron, a single-timestep simulation is run, from which a compartment report is produced. For each compartment, which are uniformly spaced, the position in Cartesian coordinates is interpolated from the 3d points in the morphology file, which do not necessarily correspond to the discretization.</p><p>After interpolation of segment positions, the H5 file defined in Sect 2.3.1 is created, with all coefficients initially set to 1. In a subsequent step, coefficients are computed, e.g., based on interpolated potential field calculated using Sim4Life (ZMT Zurich MedTech AG, Zurich, Switzerland; c.f. <xref rid="pcbi.1013023.s001" ref-type="supplementary-material">S1 Methods</xref>), or using the line-source approximation (c.f. Sect 2.1.3) or the point-source approximation (c.f. Sect2.1.4).</p><p>While the weights files are intended for runtime calculation of extracellular signals in the Neurodamus simulation control application (see Sect 2.3.4), it is also conceivable that other simulators, such as LFPy [<xref rid="pcbi.1013023.ref019" ref-type="bibr">19</xref>] or HNN [<xref rid="pcbi.1013023.ref001" ref-type="bibr">1</xref>], could be extended to accept BlueRecording weights files. This would allow these simulators to use the full set of extracellular signal calculation methods that BlueRecording provides, particularly the generalized reciprocity approach, which is not available in other simulators. Alternatively, tools such as LFPy could be extended to produce weights files in the format described in <xref rid="pcbi.1013023.t001" ref-type="table">Table 1</xref>, which could then be used with Neurodamus (see below). As LFPy provides signal calculation methods that are not available in BlueRecording (c.f. Sect 3.1.2), this would allow those methods to be used in conjunction with the efficient neural simulation toolchain used by BlueRecording.</p></sec><sec id="sec015"><title>2.3.4. Online calculation of EEG/LFP signals.</title><p>The calculation of extracellular signals is a multi-step process that begins with the launch of a Neurodamus [<xref rid="pcbi.1013023.ref007" ref-type="bibr">7</xref>] simulation. If a weights file, as defined in Sect 2.3.1, is present in the SONATA simulation config file, the weights and configuration are loaded, providing the necessary information for the subsequent extracellular signal calculation.</p><p>For each neuron distributed to a given processor, Neurodamus iterates through their corresponding sections, loading the factors associated with each section from the weights file. Neurodamus calls Neuron&#x02019;s <monospace>nbbcore_register_mapping</monospace> function, which writes the factors to an <monospace>NrnThreadMappingInfo</monospace> object &#x02013; a Neuron datatype which stores (among other data) the segment ids and corresponding LFP factors for each neuron on a given thread. On each thread at runtime, for each timestep CoreNEURON (the compute engine used by the NEURON simulation environment [<xref rid="pcbi.1013023.ref008" ref-type="bibr">8</xref>]) iterates through the neurons in the <monospace>NrnThreadMappingInfo</monospace> object, and calculates the contribution to the LFP for each neuron by summing the products of the segment transmembrane currents and their corresponding segment weights. The calculation of the contributions of the neurons to the extracellular signal is performed independently on each thread; these individual contributions are then written to a SONATA report file as described in [<xref rid="pcbi.1013023.ref009" ref-type="bibr">9</xref>]. We estimate that the online calculation of the extracellular signals adds a computational cost of 14% for 35 electrodes.</p><p>BlueRecording was developed for the CoreNEURON engine, and is not compatible with the legacy NEURON engine. Therefore, BlueRecording cannot be used in simulations of extracellular electrical stimulation or ephaptic coupling, which rely on NEURON&#x02019;s <monospace>extracellular</monospace> mechanism, which is not supported by CoreNEURON. However, rather than modeling ephaptic coupling explicitly, it is also possible to model the effects of ephaptic coupling by injecting a current into the neuron, corresponding to the impact of the activating function. In this way, it is theoretically conceivable that BlueRecording could be used to model ephaptic coupling. The extracellular potential induced by a current from each of the <italic toggle="yes">n</italic> neural compartments would need to be calculated at the location of every other neural compartment, thus requiring <inline-formula id="pcbi.1013023.e054"><alternatives><graphic xlink:href="pcbi.1013023.e054.jpg" id="pcbi.1013023.e054g" position="anchor"/><mml:math id="M54" display="inline" overflow="scroll"><mml:mrow><mml:msup><mml:mtext mathvariant="italic">n</mml:mtext><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:math></alternatives></inline-formula> weights to be computed. In a heterogeneous dielectric environment, this would require as many finite element simulations as there are neural compartments, which would be computationally infeasible. However, if we assume a homogeneous environment, then an analytic solution can be used to calculate the weights. It may be possible to reduce these computations to a reasonable degree of complexity using, for example, the fast multipole method. Injecting the appropriate currents into each compartment would also require the creation of a new current clamp mechanism, which would need to have access to the recorded extracellular potential. Thus, the implementation of ephaptic coupling using BlueRecording is conceivable but technically very difficult.</p></sec><sec id="sec016"><title>2.3.5. Reports.</title><p>For storing simulation reports, the SONATA format [<xref rid="pcbi.1013023.ref009" ref-type="bibr">9</xref>] is utilized, which organizes the data in an HDF5 file (<xref rid="pcbi.1013023.t003" ref-type="table">Table 3</xref>). This format is specifically designed to handle various types of data related to neural simulations, providing a structured and efficient way for storing and retrieving the data.</p><table-wrap position="float" id="pcbi.1013023.t003"><object-id pub-id-type="doi">10.1371/journal.pcbi.1013023.t003</object-id><label>Table 3</label><caption><title>The format of the simulation reports</title></caption><alternatives><graphic xlink:href="pcbi.1013023.t003" id="pcbi.1013023.t003g" position="float"/><table frame="hsides" rules="groups"><colgroup span="1"><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/></colgroup><thead><tr><th align="left" rowspan="1" colspan="1">Group</th><th align="left" rowspan="1" colspan="1">Field</th><th align="left" rowspan="1" colspan="1">Type</th><th align="left" rowspan="1" colspan="1">Requirement</th><th align="left" rowspan="1" colspan="1">Description</th></tr></thead><tbody><tr><td align="left" rowspan="1" colspan="1"><p>/report</p>
<p>/{<italic toggle="yes">population_name</italic>}</p></td><td align="left" rowspan="1" colspan="1">data</td><td align="left" rowspan="1" colspan="1">float32</td><td align="left" rowspan="1" colspan="1">Mandatory</td><td align="left" rowspan="1" colspan="1">The reported values. Units is defined by the &#x0201c;units" attribute.</td></tr><tr><td align="left" rowspan="1" colspan="1"><p>/report</p>
<p>/{<italic toggle="yes">population_name</italic>}/ mapping</p></td><td align="left" rowspan="1" colspan="1">node_ids</td><td align="left" rowspan="1" colspan="1">uint64</td><td align="left" rowspan="1" colspan="1">Mandatory</td><td align="left" rowspan="1" colspan="1">The set of node ids (no duplicate).</td></tr><tr><td align="left" rowspan="1" colspan="1"><p>/report</p>
<p>/{<italic toggle="yes">population_name}</italic>/ mapping</p></td><td align="left" rowspan="1" colspan="1">index_pointers</td><td align="left" rowspan="1" colspan="1">uint64</td><td align="left" rowspan="1" colspan="1">Mandatory</td><td align="left" rowspan="1" colspan="1">The offset for each node in the data field.</td></tr><tr><td align="left" rowspan="1" colspan="1"><p>/report</p>
<p>/{<italic toggle="yes">population_name</italic>}/ mapping</p></td><td align="left" rowspan="1" colspan="1">element_ids</td><td align="left" rowspan="1" colspan="1">uint32</td><td align="left" rowspan="1" colspan="1">Mandatory</td><td align="left" rowspan="1" colspan="1">Represent the compartments as in NEURON, ordered by compartment IDs and grouped by nodes. For the &#x02018;lfp&#x02019; report type, it represent the electrode IDs.</td></tr><tr><td align="left" rowspan="1" colspan="1"><p>/report</p>
<p>/{<italic toggle="yes">population_name</italic>}/ mapping</p></td><td align="left" rowspan="1" colspan="1">time</td><td align="left" rowspan="1" colspan="1">float64</td><td align="left" rowspan="1" colspan="1">Mandatory</td><td align="left" rowspan="1" colspan="1">3 values defining start time, end time, and time step. end time is not part of the report.</td></tr></tbody></table></alternatives></table-wrap><p>For extracellular reports, a unique aspect of the SONATA format is the use of the field &#x0201c;element ids&#x0201d; to represent electrode IDs, as opposed to representing compartments as in NEURON. This means that reports capture the electrical activity at specific electrode locations, rather than at individual compartments within the neural model.</p><p>An extracellular report is requested by adding an <monospace>lfp</monospace> block to the report section of the simulation configuration file (see [<xref rid="pcbi.1013023.ref009" ref-type="bibr">9</xref>] for a full description of this file).</p><p>
<monospace>"reports":{</monospace>
</p><p>
<monospace>&#x02003;"report_name":{</monospace>
</p><p>
<monospace>&#x02003;&#x02003;"type":"lfp",</monospace>
</p><p>
<monospace>&#x02003;&#x02003;"cells":"Mosaic",</monospace>
</p><p>
<monospace>&#x02003;&#x02003;"variable_name":"v",</monospace>
</p><p>
<monospace>&#x02003;&#x02003;"dt":0.1,</monospace>
</p><p>
<monospace>&#x02003;&#x02003;"start_time": 0.0,</monospace>
</p><p>
<monospace>&#x02003;&#x02003;"end_time": 5000.0,</monospace>
</p><p>
<monospace>&#x02003;&#x02003;"sections":"all"</monospace>
</p><p>
<monospace>&#x02003;}</monospace>
</p><p>
<monospace>}</monospace>
</p><p>The name-value pairs <monospace>"type":"lfp"</monospace> and <monospace>"variable_name":"v"</monospace> must be present verbatim; the others are user-configurable.</p></sec></sec></sec><sec sec-type="results" id="sec017"><title>3. Results</title><sec id="sec018"><title>3.1. Verification</title><sec id="sec019"><title>3.1.1. Unit tests.</title><p>Unit tests, with 70% code coverage, are provided in our Github repository, in the folder <monospace>tests</monospace>. These ensure, for example, that the weights files are outputted with the correct format, that segment positions are interpolated correctly for a morphology with 10 sections, and that weights are calculated correctly for a simple two-compartment model. They can be run with <monospace>pytest</monospace>.</p></sec><sec id="sec020"><title>3.1.2. Comparison of calculation methods.</title><p>We provide a small verification example in our Github repository (<ext-link xlink:href="https://github.com/BlueBrain/BlueRecording" ext-link-type="uri">https://github.com/BlueBrain/BlueRecording</ext-link>), comparing the generalized reciprocity approach, dipole-based reciprocity approach, line-source approximation, and point-source approximation, in a large homogeneous medium. We simulate the signal from a single Layer 5 pyramidal cell from the BBP somatosensory cortex (SSCx) model. The cell is driven with Ornstein-Uhlenbeck noise with an amplitude of 100% of the spiking threshold and a standard deviation of 1% (c.f. <xref rid="pcbi.1013023.s002" ref-type="supplementary-material">S2 Methods</xref>). We chose such a low standard deviation in the noise process to facilitate visualization of the differences between the signal calculation methods. In principle, a deterministic input could also have been used, but as the goal of this experiment is to verify that our calculation methods perform as expected (insofar as the differences between them match theoretical considerations), and given that Ornstein-Uhlenbeck noise input is used in larger-scale simulations described in Sects 3.2&#x02013;3.4, we elect to use Ornstein-Uhlenbeck noise here as well.</p><p>The noise input triggers an action potential in the neuron, which is observed as a large transient in the recorded signal (<xref rid="pcbi.1013023.g002" ref-type="fig">Fig 2</xref>A&#x02013;<xref rid="pcbi.1013023.g002" ref-type="fig">2</xref>B). Based on theoretical considerations outlined in the introduction, we expect a weaker signal and disappearing differences between the approaches at larger distances. We confirm that when the recording and reference electrode are located far from the neuron (30&#x02009;mm and 40&#x02009;mm, respectively), the signals recorded using each of the methods are very similar (<xref rid="pcbi.1013023.g002" ref-type="fig">Fig 2</xref>A). In contrast, when the recording electrode is placed 218.5 <inline-formula id="pcbi.1013023.e055"><alternatives><graphic xlink:href="pcbi.1013023.e055.jpg" id="pcbi.1013023.e055g" position="anchor"/><mml:math id="M55" display="inline" overflow="scroll"><mml:mrow><mml:mi>&#x003bc;</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>m from the neuron, the signals recorded using the different methods begin to diverge (<xref rid="pcbi.1013023.g002" ref-type="fig">Fig 2</xref>B), with the signal calculated using the dipole-reciprocity method diverging the most. This is the results of differences in the weights calculated for individual compartments (<xref rid="pcbi.1013023.g002" ref-type="fig">Fig 2</xref>C and <xref rid="pcbi.1013023.g002" ref-type="fig">2</xref>D). For the electrode closer to the neuron, the full reciprocity approach yields more positive weights (relative to the soma) for the apical tuft and more negative weights for the basal dendrites than the simplified dipole approach. The higher polarity between tuft and basals explains the larger amplitude of the signal observed.</p><fig position="float" id="pcbi.1013023.g002"><object-id pub-id-type="doi">10.1371/journal.pcbi.1013023.g002</object-id><label>Fig 2</label><caption><title>Extracellular signals recorded in a large homogeneous medium.</title><p>A: Signals recorded with recording electrode (not visible in panel C) distant from the neuron. B: Signals recorded with recording electrode (green dot in panel D) near the neuron. C: Difference in per-compartment weight between generalized reciprocity and dipole-based signal calculations, for electrode far from the neuron (adjusted for constant offset, and normalized to the range of compartment weights in general reciprocity approach). D: The same, for electrode close to the neuron.</p></caption><graphic xlink:href="pcbi.1013023.g002" position="float"/></fig><p>We further observe, as expected, that the signal recorded with distant electrodes (Fig <xref rid="pcbi.1013023.g002" ref-type="fig">2</xref>A) has substantially lower amplitude than the signal recorded with nearby electrodes (Fig <xref rid="pcbi.1013023.g002" ref-type="fig">2</xref>B). We do not expect that the former signal would be detectable in the presence of activity from other cells, but as the intent of this experiment is merely to compare the outputs of the different signal calculation methods, we do not consider this a limitation.</p></sec></sec><sec id="sec021"><title>3.2. Biological application: Resting state EEG</title><p>We simulated a resting-state EEG, ECoG, and LFP signal originating from the Blue Brain Project reconstruction of the rat somatosensory cortex [<xref rid="pcbi.1013023.ref010" ref-type="bibr">10</xref>]. The model consists of 4.2 million biologically detailed neuron models, positioned in space according to the Paxinos Watson rat brain atlas [<xref rid="pcbi.1013023.ref020" ref-type="bibr">20</xref>], rescaled to the size of a juvenile animal. It has been shown to produce realistic firing activities [<xref rid="pcbi.1013023.ref021" ref-type="bibr">21</xref>]. In order to calculate EEG from this model, we developed a FEM model of a rat head that is spatially aligned to the BBP somatosensory cortex (c.f. <xref rid="pcbi.1013023.s001" ref-type="supplementary-material">S1 Methods</xref>).</p><p>EEG is calculated from a recording electrode, positioned in the skull, directly above the forelimb region. A reference electrode is positioned over the hindlimb region. ECoG is produced by moving the recording electrode downward such that it is in contact with the cortical surface (<xref rid="pcbi.1013023.g003" ref-type="fig">Fig 3</xref>A). LFP is calculated by moving the electrode 1&#x02009;mm into the cortex. This will place it inside cortical layer 3.</p><fig position="float" id="pcbi.1013023.g003"><object-id pub-id-type="doi">10.1371/journal.pcbi.1013023.g003</object-id><label>Fig 3</label><caption><title>BlueRecording simulates resting-state EEG in the rat SSCx model.</title><p>A. Rat head model. i: 3D view of the surface-mesh of the rat head model. ii: Comparison between the FEM model brain (green) and the BBP somatosensory cortex model. Locations of EEG electrodes over the forelimb region (dark red) and hindlimb region (blue) and ECoG electrode over the forelimb region (bright red) marked (not to scale). iii. Somatosensory cortex model, with approximate electrode locations as in ii. B: Top down view of mean firing rate over the somatosensory cortex at i. 3200&#x02009;ms ii. 3250&#x02009;ms iii. 3300&#x02009;ms iv. 3350&#x02009;ms v 3400&#x02009;ms vi. 3500&#x02009;ms. C: i: Raster plot of firing over the entire SSCx. Arrows indicate snapshots in panel B. Red arrow indicates start of window highlighted in panels C.iii and C.iv, and Fig <xref rid="pcbi.1013023.g005" ref-type="fig">5</xref>. ii: EEG and ECoG recorded over the forelimb region. Green and red lines as in C.i. We note that due to baseline current noise injection, the signal is nonzero even in the absence of spiking activity. As the time course of recovery from hyperpolarization at the single-cell is longer than that of the action potential, we observe that the extracellular signal peak is broader than the firing burst. iii. Contributions of different regions of SSCx to the EEG recorded in ii. iv: Contributions of different regions of SSCx to the ECoG recorded in ii.</p></caption><graphic xlink:href="pcbi.1013023.g003" position="float"/></fig><p>&#x0201c;Resting state&#x0201d; activity is achieved by injecting noisy conductance to neurons, which represents uncorrelated resting-state inputs from neurons extrinsic to the model (c.f. <xref rid="pcbi.1013023.s002" ref-type="supplementary-material">S2 Methods</xref>). The simulation is run for 5 seconds of biological time; data from the first two seconds is discarded in order to exclude an initial transient. The signal is sampled at a rate of 1&#x02009;kHz. Generation of the weights file take approximately 1 hour, and the simulation runs in 7 hours on 400 nodes; each node has two 2.30 GHz, 18 core Xeon SkyLake 6140 CPUs, and 382 GB DRAM.</p><p>The model is simulated with an extracellular calcium concentration of 1.05&#x02009;mM, resulting in bursts of activity over the entire somatosensory cortex (<xref rid="pcbi.1013023.g003" ref-type="fig">Fig 3</xref>B). Originating at discrete points, these bursts spread as travelling waves through the entire model (<xref rid="pcbi.1013023.g003" ref-type="fig">Fig 3</xref>B). They occur at a frequency of 0.66&#x02009;Hz (<xref rid="pcbi.1013023.g003" ref-type="fig">Fig 3</xref>C.i), which is reflected in the EEG signal recorded over the forelimb region (<xref rid="pcbi.1013023.g003" ref-type="fig">Fig 3</xref>C.ii). The EEG signal is largely generated by the contribution of neurons from the forelimb region (FL) and the upper lip region (ULp), with smaller contributions from the dorsal zone (DZ) (<xref rid="pcbi.1013023.g003" ref-type="fig">Fig 3</xref>C.iii). Neurons in the hindlimb (HL) and trunk (Tr) area create a deflection with around a 10% of the amplitude, but opposite sign. The ECoG signal is still dominated by contributions from FL, with contributions from other regions significantly reduced, and without sign inversion in the HL and Tr regions (<xref rid="pcbi.1013023.g003" ref-type="fig">Fig 3</xref>C.iv).</p><p>To explain the difference, we investigate the weights files specifying how much the membrane current of each neuronal compartment affects the respective signal. For the EEG electrode, we found that most neurons had more positive weights associated with the apical tuft, while neurons underneath the reference electrode (corresponding to region HL) had more positive weights for their perisomatic compartments than for their tufts (<xref rid="pcbi.1013023.g004" ref-type="fig">Fig 4</xref>A). For ECoG, the difference in weight between apical and basal neurites is more pronounced directly under the recording electrode (corresponding to region FL), and less pronounced more laterally (corresponding to region ULp) (<xref rid="pcbi.1013023.g004" ref-type="fig">Fig 4</xref>B).</p><fig position="float" id="pcbi.1013023.g004"><object-id pub-id-type="doi">10.1371/journal.pcbi.1013023.g004</object-id><label>Fig 4</label><caption><title>Differences in compartment weights explain differences between EEG and ECoG.</title><p>A&#x02013;B: Weights for EEG and ECoG recordings, respectively, calculated using the reciprocity approach, for a sample of L5 pyramidal cells in the forelimb (compartments represented as circles), hindlimb (compartments represented as triangles, enclosed in pink box) and upper lip (compartments represented as squares, enclosed in red box) regions. Electrodes are represented as red circles. Note the varying color scale ranges. C&#x02013;E: Histogram of compartment weights for EEG recording, for L5 pyramidal cells in the forelimb, hindlimb, and upper lip regions, respectively. Dashed lines indicate mean values. F&#x02013;H: Same as C&#x02013;E, but for ECoG recording. Note that the x-axis range is different in each figure column.</p></caption><graphic xlink:href="pcbi.1013023.g004" position="float"/></fig><p>We confirmed this trend by considering the distribution of weights associated with basal and apical dendrite compartments (<xref rid="pcbi.1013023.g004" ref-type="fig">Fig 4</xref>C&#x02013;<xref rid="pcbi.1013023.g004" ref-type="fig">4</xref>H). Specifically, apical compartments had more positive weights than basal compartments in forelimb and upper lip associated regions. For the EEG electrode, but not the ECoG electrode, basal compartments have more positive weights then apical compartments in the hindlimb region (<xref rid="pcbi.1013023.g004" ref-type="fig">Fig 4</xref>D vs. <xref rid="pcbi.1013023.g004" ref-type="fig">4</xref>G).</p><p>If membrane currents in this highly excitable state are dominated by active currents around the soma, compensated by return currents of the apical dendrites, this explains the observed inversion between contributions from the forelimb and hindlimb regions in EEG. This also demonstrates that although the EEG and ECoG signal appear very similar under the simulated conditions, their neuronal origin is very different.</p><sec id="sec022"><title>3.2.1. Utility of the generalized reciprocity approach.</title><p>We compare the EEG, ECoG, and LFP signals obtained with the generalized reciprocity approach to those obtained with the dipole-based reciprocity approach and the line- and point-source approximations (<xref rid="pcbi.1013023.g005" ref-type="fig">Fig 5</xref>A&#x02013;<xref rid="pcbi.1013023.g005" ref-type="fig">5</xref>C). The dipole-based approach overestimates the amplitude of the EEG and ECoG signal by a factor of <inline-formula id="pcbi.1013023.e056"><alternatives><graphic xlink:href="pcbi.1013023.e056.jpg" id="pcbi.1013023.e056g" position="anchor"/><mml:math id="M56" display="inline" overflow="scroll"><mml:mrow><mml:mi>~</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>1.5 relative to the generalized reciprocity approach (Fig <xref rid="pcbi.1013023.g005" ref-type="fig">5</xref>A). This is attributable to differences in the contribution from the upper lip and hindlimb regions (<xref rid="pcbi.1013023.g005" ref-type="fig">Fig 5</xref>D). These differences can in turn be explained by differences between the generalized and dipole approach in the compartment weights in the upper lip and hindlimb regions (<xref rid="pcbi.1013023.g005" ref-type="fig">Fig 5</xref>G vs. <xref rid="pcbi.1013023.g005" ref-type="fig">5</xref>J). The differences in compartment weights between the two methods arise due to the spatial heterogeneity of the E-field on the scale of the transmembrane current sources represented by a single dipole, which is accounted for by the generalized reciprocity approach (based on the finite element model of a virtual current applied between the recording electrodes), while the dipole approach assumes negligible field homogeneity , which can be inaccurate (<xref rid="pcbi.1013023.s004" ref-type="supplementary-material">S2 Fig</xref>). The field heterogeneity depends on the geometry of the dielectric environment.</p><fig position="float" id="pcbi.1013023.g005"><object-id pub-id-type="doi">10.1371/journal.pcbi.1013023.g005</object-id><label>Fig 5</label><caption><title>Simplified calculation methods produce inaccurate signals.</title><p>EEG (A), ECoG (B), and LFP (C) signals, recorded over, or within, the somatosensory cortex, calculated with the point-source and line-source approximation, with the generalized reciprocity theorem (ground truth), and with the simplified dipole-based approaches. D-F: Contribution of each region to EEG, ECoG, and LFP signals, respectively. Solid lines indicate general reciprocity approach, dashed lines indicate dipole approach. G-I: Weights for EEG, ECoG, and LFP recordings, respectively, calculated using the reciprocity approach, for a sample of L5 pyramidal cells in the forelimb (compartments represented as circles), hindlimb (compartments represented as triangles, and enclosed in pink box) and upper lip (compartments represented as squares, and enclosed in red box) regions. Electrodes are represented as red circles. Note the varying color scale ranges. J-L: As in G-I, but calculated using the dipole approach</p></caption><graphic xlink:href="pcbi.1013023.g005" position="float"/></fig><p>Surprisingly, the dipole approximation provides a better fit to the generalized reciprocity signal for ECoG (<xref rid="pcbi.1013023.g005" ref-type="fig">Fig 5</xref>B) than for EEG. This is because, in ECoG, the dipole approximation induces a larger error in the signal contribution from the forelimb region, in the opposite direction as the error in the contribution from the other regions (<xref rid="pcbi.1013023.g005" ref-type="fig">Fig 5</xref>E). Thus, while the general reciprocity and dipole approaches produce similar signals, their interpretation is very different.</p><p>For LFP recordings, not only does the dipole-based approach overestimate the signal amplitude &#x02013; it also changes the shape of the signal, leading to a loss of information and reduced interpretability. A smaller change in shape is also observed for the point- and line-source approximations (<xref rid="pcbi.1013023.g005" ref-type="fig">Fig 5</xref>C).</p><p>While the line-source and point source approaches provide a reasonable approximation of the EEG and LFP signals obtained using the generalized reciprocity approach (<xref rid="pcbi.1013023.g005" ref-type="fig">Figs 5</xref>A and <xref rid="pcbi.1013023.g005" ref-type="fig">5</xref>C), they lead to even greater error than the dipole approximation for the ECoG signal. Therefore, the generalized reciprocity approach is the only method capable of producing realistic results in all cases.</p><p>We emphasize that the dipole reciprocity approach is derived from the generalized approach under the additional simplifying assumption that the E field is constant over the range of the neural source, which is not true near the electrode (<xref rid="pcbi.1013023.s004" ref-type="supplementary-material">S2 Fig</xref>). The point and line source approaches similarly involve approximations that are not required by the reciprocity-based approaches, namely, that the extracellular medium is infinite and homogeneous, and that the recording electrodes are infinitesimally small. The generalized reciprocity approach, which does not rely on such simplifications, is inherently more accurate. While the line-source approach has the benefit of accounting for the finite extent of neural segments, it is evident, e.g., from <xref rid="pcbi.1013023.g002" ref-type="fig">Fig 2</xref>B, that the associated error is negligible, even relatively close to neurons.</p><p>Several previous studies have investigated the adequacy of different methods for calculating extracellular signals in neural models. It has been established that, even for homogeneous tissues, within a millimeter of a neuron, the dipole approximation can produce substantial errors, but that it holds for electrode positions several millimeters from the neuron [<xref rid="pcbi.1013023.ref005" ref-type="bibr">5</xref>]. This is in accordance with our observations in <xref rid="pcbi.1013023.g002" ref-type="fig">Figs 2</xref>, <xref rid="pcbi.1013023.g005" ref-type="fig">5</xref>C and <xref rid="pcbi.1013023.g005" ref-type="fig">5</xref>F.</p><p>Naess <italic toggle="yes">et al</italic>. [<xref rid="pcbi.1013023.ref005" ref-type="bibr">5</xref>] found that in an analytically solvable four-sphere human head model, the dipole reciprocity approach performed well for EEG, but resulted in substantial errors compared to a multi-dipole approach for ECoG recordings.Halnes <italic toggle="yes">et al</italic>. [<xref rid="pcbi.1013023.ref017" ref-type="bibr">17</xref>] found that, unlike for the four-sphere human head model, the dipole reciprocity approach resulted in poor performance for EEG compared to a multi-dipole approach. In both human ECoG and mouse EEG, the dipole approximation fails when the electrode is too close to the neural current source. These findings are in accordance with our observation that in a realistic rat head model, the dipole approach results in substantial errors for both EEG and ECoG compared to the analytically correct generalized reciprocity method. Obviously, even in a realistically heterogeneous human head model, the dipole approach incurs less simplification error than in a rodent model, because of the much larger electrode-source distance. Furthermore, validation using the four-sphere human model, while advantageous because of the existence of an analytical solution, is very likely to underestimate the dipole method error: For example, scalp-to-cortex distances in real heads can vary by up to 10&#x02009;mm depending on location [<xref rid="pcbi.1013023.ref022" ref-type="bibr">22</xref>] and bone thickness and composition also shows a strong variation, negatively affecting the agreement of EEG signals predicted using the dipole approximation and the ground truth [<xref rid="pcbi.1013023.ref005" ref-type="bibr">5</xref>].</p><p>Previous studies have also examined signal calculation methods that are not currently available in BlueRecording, but which may be implemented in the future. For example, Ness <italic toggle="yes">et al</italic>. [<xref rid="pcbi.1013023.ref023" ref-type="bibr">23</xref>] found that the Method of Images accurately approximates results using a forward finite element approach in a model of a microelectrode array. However, unlike reciprocity-based approaches, the Method of Images depends on highly restrictive assumptions on the structure of the dielectric medium: the neural source is assumed to be surrounded by semi-infinite homogeneous media. Beltrachini [<xref rid="pcbi.1013023.ref024" ref-type="bibr">24</xref>] showed that a finite element subtraction approach using a quadripolar neural source outperformed a similar approach using only dipoles. While this method was able to accurately approximate a distributed source for EEG recordings in a human head model, the error will necessarily be greater when the electrodes are closer to the source &#x02013; which is the case for ECoG or rodent EEG &#x02013; as the second-order Taylor series approximation that underlies the quadripolar approach, while superior to the lower-order dipolar approximation, will break down close to the neural source, where higher-order terms must be considered.</p></sec></sec><sec id="sec023"><title>3.3. Biological application: Whisker flick</title><p>In a seven-column subvolume of the somatosensory cortex, we simulate a whisker flick stimulus, as in [<xref rid="pcbi.1013023.ref021" ref-type="bibr">21</xref>]. Briefly, a population of virtual (i.e., not biophysically modeled) thalamic fibers, projecting primarily to the central column of the subvolume (<xref rid="pcbi.1013023.g006" ref-type="fig">Fig 6</xref>A), is activated. We repeat the experiment for a circuit in which all cortico-cortical connections have been removed. EEG is recorded from the same electrodes used in the previous section, and averaged over 10 trials.</p><fig position="float" id="pcbi.1013023.g006"><object-id pub-id-type="doi">10.1371/journal.pcbi.1013023.g006</object-id><label>Fig 6</label><caption><title>BlueRecording simulates whisker-flick EEG.</title><p>A: Selected cells from the 7-column subvolume (blue) and activated thalamic projections (orange). B: Firing rate (first column) and EEG (second column) for the original and the disconnected circuit (red and blue traces, respectively) and the difference in the EEG between the two circuits (third column), for both the full circuit (first row) and each of the layers (subsequent rows). C: Correlation matrices between excitatory (first row) and inhibitory (second row) firing rates in each layer, and the differences in EEG contributions from each layer. In each correlation matrix, firing rates are represented along the rows, and EEG differences along the columns. Correlations are calculated for the full window (first column) and for windows 12-45&#x02009;ms after the stimulus, and 40-200&#x02009;ms after the stimulus (second, and third columns, respectively). Start and end times of the windows are marked by red arrows in panel B.</p></caption><graphic xlink:href="pcbi.1013023.g006" position="float"/></fig><p>While stimulus triggered more sustained spiking in the connected circuits than in the disconnected circuit (<xref rid="pcbi.1013023.g006" ref-type="fig">Fig 6</xref>B.i), the EEG signal is remarkably similar (<xref rid="pcbi.1013023.g006" ref-type="fig">Fig 6</xref>B.ii). Differences are observed in the EEG contributions of different layers, particularly L4 (<xref rid="pcbi.1013023.g006" ref-type="fig">Fig 6</xref>B.xi), L5 (<xref rid="pcbi.1013023.g006" ref-type="fig">Fig 6</xref>B.xiv), and L6 (<xref rid="pcbi.1013023.g006" ref-type="fig">Fig 6</xref>B.xvii). However, these differences largely compensate.</p><p>We calculate the Pearson correlation between firing rates (in the original circuit) of excitatory and inhibitory cells in each layer, and the difference between the original and the disconnected circuit in the EEG contributions of cells in each layer. Because EEG is driven primarily by synaptic input [<xref rid="pcbi.1013023.ref025" ref-type="bibr">25</xref>], the correlation between the firing rate of a specified presynaptic population and the EEG difference in a specified postsynaptic population provides information about the functional connectivity between the two populations &#x02013; a strong correlation between presynaptic firing rate and the difference in postsynaptic EEG suggests that the presynaptic population provides (not necessarily direct) synaptic input to the postsynaptic population. Of course, it is possible that both the firing rate of the presynaptic population and the EEG difference in the postsynaptic population are driven by a hidden third population, but this is a limitation of most functional connectivity metrics.</p><p>Over the entire time window, excitatory firing rates tend to correlate more strongly with EEG differences than inhibitory firing rates (<xref rid="pcbi.1013023.g006" ref-type="fig">Figs 6</xref>C.i and <xref rid="pcbi.1013023.g006" ref-type="fig">6</xref>C.v). Between 12 and 40&#x02009;ms after the stimulus, inhibitory firing rates in all layers besides L2/3 correlate negatively with the difference in the L5 contribution to the EEG between the original and disconnected circuit (<xref rid="pcbi.1013023.g006" ref-type="fig">Fig 6</xref>C.v), suggesting that the negative deflection the L5 EEG difference (<xref rid="pcbi.1013023.g006" ref-type="fig">Fig 6</xref>B.xv) may be due to inhibitory inputs to L5 cells that are absent in the disconnected circuit. Between 40 and 175&#x02009;ms after the stimulus, there is a positive correlation between L2/3 and L4 inhibitory firing rates and the EEG difference in Layer 5 (<xref rid="pcbi.1013023.g006" ref-type="fig">Fig 6</xref>C.vi). This suggests that the positive deflection in the L5 EEG difference (<xref rid="pcbi.1013023.g006" ref-type="fig">Fig 6</xref>B.xv) may be due to inhibitory inputs from layers 2-4 to L4 that are missing in the disconnected circuit. BlueRecording thus provides a method to suggest possible interpretations of EEG signals in terms of functional connectivity, and to predict firing rates from EEG.</p><p>We do not claim that the results presented here provide general insight into the organization of cortical circuits more broadly; the extent to which the SSCx whisker flick results generalize to other regions and conditions is an empirical question beyond the scope of this paper. Rather, this study demonstrates the ability of BlueRecording to simulate neural recording <italic toggle="yes">in silico</italic> and to leverage this to disentangle and shed light on signal contributions for different subpopulations, and to elucidate the role of the functional organization of neural microcircuits. Such results can serve to formulate testable hypotheses and to constrain putative mechanisms of action. Extending this approach to other regions and regimes is a promising future application for BlueRecording.</p></sec><sec id="sec024"><title>3.4. Biological application: Hippocampal theta oscillations</title><p>As in [<xref rid="pcbi.1013023.ref011" ref-type="bibr">11</xref>], we simulated medial septal input to a subvolume of the hippocampal CA1 model consisting of a cylinder with diameter 600 <inline-formula id="pcbi.1013023.e057"><alternatives><graphic xlink:href="pcbi.1013023.e057.jpg" id="pcbi.1013023.e057g" position="anchor"/><mml:math id="M57" display="inline" overflow="scroll"><mml:mrow><mml:mi>&#x003bc;</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>m. We are also able to simulate LFP recordings from the full circuit of <inline-formula id="pcbi.1013023.e058"><alternatives><graphic xlink:href="pcbi.1013023.e058.jpg" id="pcbi.1013023.e058g" position="anchor"/><mml:math id="M58" display="inline" overflow="scroll"><mml:mrow><mml:mi>~</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>456000 neurons. In both cases, we apply a depolarisation current of 120% of the spiking threshold to all cells. A sinusoidal current of -0.2 nA and frequency of 8 Hz is injected in PV+ cells using a <monospace>NONSPECIFIC_CURRENT</monospace> in Neuron (c.f. <xref rid="pcbi.1013023.s002" ref-type="supplementary-material">S2 Methods</xref>). We mimic the effect of 1.0 uM ACh on synapses and cell excitability as described in [<xref rid="pcbi.1013023.ref011" ref-type="bibr">11</xref>].</p><p>We calculate the LFP signal in both circuits using BlueRecording, with the line-source approximation. We are able to replicate the finding in [<xref rid="pcbi.1013023.ref011" ref-type="bibr">11</xref>] that the simulated medial septal input results in LFP oscillations at <inline-formula id="pcbi.1013023.e059"><alternatives><graphic xlink:href="pcbi.1013023.e059.jpg" id="pcbi.1013023.e059g" position="anchor"/><mml:math id="M59" display="inline" overflow="scroll"><mml:mrow><mml:mi>~</mml:mi></mml:mrow></mml:math></alternatives></inline-formula> 8 Hz (<xref rid="pcbi.1013023.g007" ref-type="fig">Figs 7</xref>C&#x02013;<xref rid="pcbi.1013023.g007" ref-type="fig">7</xref>G). The LFPs calculated for the two circuits (<xref rid="pcbi.1013023.g007" ref-type="fig">Fig 7</xref>D), as well as the resulting power-spectral densities (<xref rid="pcbi.1013023.g007" ref-type="fig">Figs 7</xref>E) and current-source densities (<xref rid="pcbi.1013023.g007" ref-type="fig">Figs 7</xref>F&#x02013;<xref rid="pcbi.1013023.g007" ref-type="fig">7</xref>G), are very similar in both circuits, albeit with higher power in the full hippocampal circuit (<xref rid="pcbi.1013023.g007" ref-type="fig">Fig 7</xref>). These results suggest that the findings in [<xref rid="pcbi.1013023.ref011" ref-type="bibr">11</xref>] generalize to a larger circuit model.</p><fig position="float" id="pcbi.1013023.g007"><object-id pub-id-type="doi">10.1371/journal.pcbi.1013023.g007</object-id><label>Fig 7</label><caption><title>BlueRecording simulates hippocampal LFP.</title><p>A: Visualization of the hippocampus and cylindrical subvolumes. B: Visualization of recording electrode placement. C: Raster plot of activity in the full hippocampus (i) and the cylindrical subvolume (ii). D: LFP recorded from a representative electrode in the hippocampus. E: Power-spectral density calculated for the signals in panel D. F: Current source density (CSD) calculated in the full hippocampus simulation. G: Current source density calculated in the cylindrical circuit. CSD maps are calculated using the standard CSD method with Vankin correction [<xref rid="pcbi.1013023.ref026" ref-type="bibr">26</xref>], as implemented by Rimehaug <italic toggle="yes">et al</italic>. [<xref rid="pcbi.1013023.ref027" ref-type="bibr">27</xref>]</p></caption><graphic xlink:href="pcbi.1013023.g007" position="float"/></fig></sec><sec id="sec025"><title>3.5. Comparison with existing tools</title><p>In <xref rid="pcbi.1013023.t004" ref-type="table">Table 4</xref>, we compare BlueRecording with several existing tools. We estimate the amount of time required by these tools to run a simulation the size of the SSCx model on equivalent hardware, under the assumption that computational time is directly proportional to network size and inversely proportional to the number of available CPU cores. Thus, for a network of size <italic toggle="yes">N</italic> cells run on <italic toggle="yes">C</italic> cores, computational time <inline-formula id="pcbi.1013023.e061"><alternatives><graphic xlink:href="pcbi.1013023.e061.jpg" id="pcbi.1013023.e061g" position="anchor"/><mml:math id="M60" display="inline" overflow="scroll"><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mfrac><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mi>B</mml:mi></mml:msub><mml:msub><mml:mi>C</mml:mi><mml:mi>B</mml:mi></mml:msub><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mi>N</mml:mi><mml:mi>B</mml:mi></mml:msub><mml:mi>C</mml:mi></mml:mrow></mml:mfrac></mml:mstyle></mml:mrow></mml:math></alternatives></inline-formula>, where <italic toggle="yes">t</italic><sub><italic toggle="yes">B</italic></sub>, <italic toggle="yes">N</italic><sub><italic toggle="yes">B</italic></sub>, and <italic toggle="yes">C</italic><sub><italic toggle="yes">B</italic></sub> are reported times, network sizes, and numbers of cores reported in [<xref rid="pcbi.1013023.ref028" ref-type="bibr">28</xref>] and [<xref rid="pcbi.1013023.ref029" ref-type="bibr">29</xref>] for LFPy and Bionet, respectively. We do not account for differences in CPU clock speed or available RAM. We show that both in terms of available signal calculation methods and in terms of performance, BlueRecording outperforms the state of the art by a significant margin. However, we were unable to assess the performance of HNN, and we note that LFPy supports several analytical methods for the calculation of extracellular signals that are not supported by BlueRecording. Because the calculation of extracellular signals itself is not a significant source of computational cost, either in BlueRecording or in the alternatives described above, the performance advantages of BlueRecording can be attributed to its tight integration with CoreNEURON, which is optimized for computational performance for large networks. In contrast, neither LFPy nor BioNet use CoreNEURON. Compared to legacy Neuron, CoreNEURON speeds up computations up to 7-fold [<xref rid="pcbi.1013023.ref008" ref-type="bibr">8</xref>]. Unlike BlueRecording, where the calculation of extracellular signals is performed within CoreNEURON, both LFPy and BioNet pass membrane currents from Neuron to a Python API at each time step in order to calculate extracellular signals. Per-timestep calls to the Python interpreter are not possible in CoreNEURON. Thus, achieving the same speeds as BlueRecording in LFPy or BioNet would require significant refactoring.</p><table-wrap position="float" id="pcbi.1013023.t004"><object-id pub-id-type="doi">10.1371/journal.pcbi.1013023.t004</object-id><label>Table 4</label><caption><title>Comparison of BlueRecording with existing tools</title></caption><alternatives><graphic xlink:href="pcbi.1013023.t004" id="pcbi.1013023.t004g" position="float"/><table frame="hsides" rules="groups"><colgroup span="1"><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/></colgroup><thead><tr><th align="left" rowspan="1" colspan="1">Feature</th><th align="left" rowspan="1" colspan="1">Human Neocortical Neurosolver</th><th align="left" rowspan="1" colspan="1">BioNet</th><th align="left" rowspan="1" colspan="1">LFPy</th><th align="left" rowspan="1" colspan="1">BlueRecording</th></tr></thead><tbody><tr><td align="left" rowspan="1" colspan="1">Line-Source Approximation</td><td align="left" rowspan="1" colspan="1">No</td><td align="left" rowspan="1" colspan="1">Yes</td><td align="left" rowspan="1" colspan="1">Yes</td><td align="left" rowspan="1" colspan="1">Yes</td></tr><tr><td align="left" rowspan="1" colspan="1">Analytic Calculation with Simplified Head</td><td align="left" rowspan="1" colspan="1">No</td><td align="left" rowspan="1" colspan="1">No</td><td align="left" rowspan="1" colspan="1">Yes</td><td align="left" rowspan="1" colspan="1">No</td></tr><tr><td align="left" rowspan="1" colspan="1">Reciprocity Calculation with Dipole Approximation</td><td align="left" rowspan="1" colspan="1">No</td><td align="left" rowspan="1" colspan="1">No</td><td align="left" rowspan="1" colspan="1">Yes</td><td align="left" rowspan="1" colspan="1">Yes</td></tr><tr><td align="left" rowspan="1" colspan="1">Detailed Reciprocity Calculation</td><td align="left" rowspan="1" colspan="1">No</td><td align="left" rowspan="1" colspan="1">No</td><td align="left" rowspan="1" colspan="1">No</td><td align="left" rowspan="1" colspan="1">Yes</td></tr><tr><td align="left" rowspan="1" colspan="1">Morphologies</td><td align="left" rowspan="1" colspan="1">Simplified morphology templates built-in; creating other morphologies nontrivial</td><td align="left" rowspan="1" colspan="1">Arbitrary</td><td align="left" rowspan="1" colspan="1">Arbitrary</td><td align="left" rowspan="1" colspan="1">Arbitrary</td></tr><tr><td align="left" rowspan="1" colspan="1">Circuit specification</td><td align="left" rowspan="1" colspan="1">Built-in templates; user-editable connectivity</td><td align="left" rowspan="1" colspan="1">SONATA</td><td align="left" rowspan="1" colspan="1">Ad hoc; instantiated in code</td><td align="left" rowspan="1" colspan="1">SONATA</td></tr><tr><td align="left" rowspan="1" colspan="1">Estimated Simulation Time for SSCx-sized Circuit (<inline-formula id="pcbi.1013023.e060"><alternatives><graphic xlink:href="pcbi.1013023.e060" id="pcbi.1013023.e060g" position="anchor"/><mml:math id="M61" display="inline" overflow="scroll"><mml:mrow><mml:mi>~</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>4.2 million neurons, assuming 14400 cores)</td><td align="left" rowspan="1" colspan="1">Insufficient published data to estimate</td><td align="left" rowspan="1" colspan="1">23.3 hours</td><td align="left" rowspan="1" colspan="1">28.8 hours</td><td align="left" rowspan="1" colspan="1">7 hours</td></tr></tbody></table></alternatives></table-wrap></sec></sec><sec id="sec026"><title>4. Availability and future directions</title><sec id="sec027"><title>4.1. Code availability and dependencies</title><list list-type="bullet"><list-item><p>The source code for BlueRecording, and instructions for generating the figures in Sects 3.1.2, 3.2, 3.3, and 3.4 are available at <ext-link xlink:href="https://github.com/BlueBrain/BlueRecording" ext-link-type="uri">https://github.com/BlueBrain/BlueRecording</ext-link>.</p></list-item><list-item><p>The seven column subvolume of the BBP circuit model is available under the following DOI: <ext-link xlink:href="https://doi.org/10.5281/zenodo.11113043" ext-link-type="uri">https://doi.org/10.5281/zenodo.11113043</ext-link>. The full BBP circuit model is available on Harvard Dataverse under the following DOI: <ext-link xlink:href="https://doi.org/10.7910/DVN/HISHXN" ext-link-type="uri">https://doi.org/10.7910/DVN/HISHXN</ext-link>, and the hippocampus model is available on Harvard Dataverse under the following DOI: <ext-link xlink:href="https://doi.org/10.7910/DVN/TN3DUI" ext-link-type="uri">https://doi.org/10.7910/DVN/TN3DUI</ext-link>.</p></list-item><list-item><p>Membrane mechanism files used in the neuro-simulations are available at <ext-link xlink:href="https://github.com/BlueBrain/neurodamus-models" ext-link-type="uri">https://github.com/BlueBrain/neurodamus-models</ext-link>.</p></list-item><list-item><p>The specification for the version of the SONATA format used at BBP is available at <ext-link xlink:href="https://github.com/BlueBrain/sonata-extension/" ext-link-type="uri">https://github.com/BlueBrain/sonata-extension/</ext-link>.</p></list-item><list-item><p>Neurodamus is available at <ext-link xlink:href="https://github.com/BlueBrain/neurodamus" ext-link-type="uri">https://github.com/BlueBrain/neurodamus</ext-link>.</p></list-item><list-item><p>CoreNEURON itself is fully integrated into the NEURON simulation environment, which is available at <ext-link xlink:href="https://github.com/neuronsimulator/nrn" ext-link-type="uri">https://github.com/neuronsimulator/nrn</ext-link>.</p></list-item><list-item><p>Code for the generation of FEM models, as well as a list of dependencies, is available at <ext-link xlink:href="https://github.com/BlueBrain/BlueBrainHeadModels" ext-link-type="uri">https://github.com/BlueBrain/BlueBrainHeadModels</ext-link>. The required finite element meshes are available on Zenodo (<ext-link xlink:href="https://doi.org/10.5281/zenodo.10926947" ext-link-type="uri">https://doi.org/10.5281/zenodo.10926947</ext-link>). As this pipeline is specific to the demonstration application presented in this work, we do not consider it to be part of the core BlueRecording package.</p></list-item><list-item><p>Finite element meshes and FEM output files used in the simulations in Sects 3.1.2, 3.2, and 3.3 are available on Zenodo (<ext-link xlink:href="https://doi.org/10.5281/zenodo.14419388" ext-link-type="uri">https://doi.org/10.5281/zenodo.14419388</ext-link>).</p></list-item></list></sec><sec id="sec028"><title>4.2. Long-term outlook</title><p>We anticipate that BlueRecording can be easily extended to permit simulation of linear signals from other recording modalities, both electromagnetic, such as MEG, and optical, such as VSDI, by simply writing the appropriate coefficients to the weights file, and in the case of VSDI, multiplying the weights by the segment voltage rather than the transmembrane current. A weights file could also be generated to directly calculate the current source density, or the current dipole itself, rather than an electromagnetic signal.</p><p>Because BlueRecording is compatible with the SONATA format, it can readily be used in hybrid models, where the dominant contributors are modeled in morphological detail, while other contributors are represented by simplified point neurons (similar to HNN) or neural masses. Such hybrid models permit the simulation of even larger models, or to run SSCx-sized models on less performant computational infrastructure.</p></sec></sec><sec id="sec029" sec-type="supplementary-material"><title>Supporting information</title><supplementary-material id="pcbi.1013023.s001" position="float" content-type="local-data"><label>S1 Methods</label><caption><title>Methods for the generation of finite element meshes and simulation of electric fields.</title><p>(PDF)</p></caption><media xlink:href="pcbi.1013023.s001.pdf"/></supplementary-material><supplementary-material id="pcbi.1013023.s002" position="float" content-type="local-data"><label>S2 Methods</label><caption><title>Methods for the input of current or conductance noise to the model.</title><p>(PDF)</p></caption><media xlink:href="pcbi.1013023.s002.pdf"/></supplementary-material><supplementary-material id="pcbi.1013023.s003" position="float" content-type="local-data"><label>S1 Fig</label><caption><title>Procedure for aligning the NeuroRat head model underlying the FEM simulations with the BBP circuit model.</title><p>Blue blocks represent input and output files, while pink blocks represent processes. For processes that generate transformations between two images, blue arrows represent the moving image, while red arrows represent the target image. Black arrows represent inputs that are transformed by processes and the resulting outputs. For processes that apply a transformation to an image, purple arrows represent the transformation object used.</p><p>(TIFF)</p></caption><media xlink:href="pcbi.1013023.s003.tiff"/></supplementary-material><supplementary-material id="pcbi.1013023.s004" position="float" content-type="local-data"><label>S2 Fig</label><caption><title>A. E-Field magnitude, in a cross section of the rat head, induced by current applied to an ECoG recording electrode.</title><p>The scalp (beige), cancelous skull (white), and somatosensory cortex (blue) are displayed for context. B. Zoom in on the boxed area in panel a, with scalp and skull removed. Somatosensory cortex is displayed in blue. The E-field magnitude within the somatosensory cortex varies significantly (highlighted in the green box), demonstrating that the dipole approximation is not valid for ECoG recordings.</p><p>(EPS)</p></caption><media xlink:href="pcbi.1013023.s004.eps"/></supplementary-material><supplementary-material id="pcbi.1013023.s005" position="float" content-type="local-data"><label>S1 Table</label><caption><title>The format of FEM output. We list only those fields which are used by BlueRecording.</title><p>The format is identical to output files from a Sim4Life Electro-ohmic Quasi-static simulation.</p><p>(PDF)</p></caption><media xlink:href="pcbi.1013023.s005.pdf"/></supplementary-material></sec></body><back><ack><p>We thank Julian Budd for his assistance with the hippocampus model, and Stephanie Jones for her helpful comments on the paper.</p></ack><ref-list><title>References</title><ref id="pcbi.1013023.ref001"><label>1</label><mixed-citation publication-type="journal"><name><surname>Neymotin</surname><given-names>SA</given-names></name>, <name><surname>Daniels</surname><given-names>DS</given-names></name>, <name><surname>Caldwell</surname><given-names>B</given-names></name>, <name><surname>McDougal</surname><given-names>RA</given-names></name>, <name><surname>Carnevale</surname><given-names>NT</given-names></name>, <name><surname>Jas</surname><given-names>M</given-names></name>, <etal>et al</etal>. <article-title>Human Neocortical Neurosolver (HNN), a new software tool for interpreting the cellular and network origin of human MEG/EEG data</article-title>. <source>Elife</source>. <year>2020</year>;<volume>9</volume>:e51214. <comment>doi: </comment><pub-id pub-id-type="doi">10.7554/eLife.51214</pub-id>
<pub-id pub-id-type="pmid">31967544</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref002"><label>2</label><mixed-citation publication-type="journal"><name><surname>Hagen</surname><given-names>E</given-names></name>, <name><surname>N&#x000e6;ss</surname><given-names>S</given-names></name>, <name><surname>Ness</surname><given-names>TV</given-names></name>, <name><surname>Einevoll</surname><given-names>GT</given-names></name>. <article-title>Multimodal modeling of neural network activity: computing LFP, ECoG, EEG, and MEG signals with LFPy 2.0</article-title>. <source>Front Neuroinform</source>. <year>2018</year>;<volume>12</volume>:<fpage>92</fpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.3389/fninf.2018.00092</pub-id>
<pub-id pub-id-type="pmid">30618697</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref003"><label>3</label><mixed-citation publication-type="journal"><name><surname>Baratham</surname><given-names>VL</given-names></name>, <name><surname>Dougherty</surname><given-names>ME</given-names></name>, <name><surname>Hermiz</surname><given-names>J</given-names></name>, <name><surname>Ledochowitsch</surname><given-names>P</given-names></name>, <name><surname>Maharbiz</surname><given-names>MM</given-names></name>, <name><surname>Bouchard</surname><given-names>KE</given-names></name>. <article-title>Columnar localization and laminar origin of cortical surface electrical potentials</article-title>. <source>J Neurosci</source>. <year>2022</year>;<volume>42</volume>(<issue>18</issue>):<fpage>3733</fpage>&#x02013;<lpage>48</lpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.1523/JNEUROSCI.1787-21.2022</pub-id>
<pub-id pub-id-type="pmid">35332084</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref004"><label>4</label><mixed-citation publication-type="journal"><name><surname>Rimehaug</surname><given-names>AE</given-names></name>, <name><surname>Stasik</surname><given-names>AJ</given-names></name>, <name><surname>Hagen</surname><given-names>E</given-names></name>, <name><surname>Billeh</surname><given-names>YN</given-names></name>, <name><surname>Siegle</surname><given-names>JH</given-names></name>, <name><surname>Dai</surname><given-names>K</given-names></name>, <etal>et al</etal>. <article-title>Uncovering circuit mechanisms of current sinks and sources with biophysical simulations of primary visual cortex</article-title>. <source>Elife</source>. <year>2023</year>;<volume>12</volume>:e87169. <comment>doi: </comment><pub-id pub-id-type="doi">10.7554/eLife.87169</pub-id>
<pub-id pub-id-type="pmid">37486105</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref005"><label>5</label><mixed-citation publication-type="journal"><name><surname>N&#x000e6;ss</surname><given-names>S</given-names></name>, <name><surname>Halnes</surname><given-names>G</given-names></name>, <name><surname>Hagen</surname><given-names>E</given-names></name>, <name><surname>Hagler</surname><given-names>DJ</given-names><suffix>Jr</suffix></name>, <name><surname>Dale</surname><given-names>AM</given-names></name>, <name><surname>Einevoll</surname><given-names>GT</given-names></name>, <etal>et al</etal>. <article-title>Biophysically detailed forward modeling of the neural origin of EEG and MEG signals</article-title>. <source>Neuroimage</source>. <year>2021</year>;<volume>225</volume>:<fpage>117467</fpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.1016/j.neuroimage.2020.117467</pub-id>
<pub-id pub-id-type="pmid">33075556</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref006"><label>6</label><mixed-citation publication-type="journal"><name><surname>Plonsey</surname><given-names>R</given-names></name>. <article-title>Reciprocity applied to volume conductors and the ECG</article-title>. <source>IEEE Trans Biomed Eng</source>. <year>1963</year>;<volume>10</volume>:<fpage>9</fpage>&#x02013;<lpage>12</lpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.1109/tbmel.1963.4322775</pub-id>
<pub-id pub-id-type="pmid">14059530</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref007"><label>7</label><mixed-citation publication-type="journal"><name><surname>King</surname><given-names>JG</given-names></name>, <name><surname>Hines</surname><given-names>M</given-names></name>, <name><surname>Hill</surname><given-names>S</given-names></name>, <name><surname>Goodman</surname><given-names>PH</given-names></name>, <name><surname>Markram</surname><given-names>H</given-names></name>, <name><surname>Sch&#x000fc;rmann</surname><given-names>F</given-names></name>. <article-title>A component-based extension framework for large-scale parallel simulations in NEURON</article-title>. <source>Front Neuroinform</source>. <year>2009</year>;<volume>3</volume>:<fpage>10</fpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.3389/neuro.11.010.2009</pub-id>
<pub-id pub-id-type="pmid">19430597</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref008"><label>8</label><mixed-citation publication-type="journal"><name><surname>Kumbhar</surname><given-names>P</given-names></name>, <name><surname>Hines</surname><given-names>M</given-names></name>, <name><surname>Fouriaux</surname><given-names>J</given-names></name>, <name><surname>Ovcharenko</surname><given-names>A</given-names></name>, <name><surname>King</surname><given-names>J</given-names></name>, <name><surname>Delalondre</surname><given-names>F</given-names></name>, <etal>et al</etal>. <article-title>CoreNEURON&#x0202f;: an optimized compute engine for the NEURON simulator</article-title>. <source>Front Neuroinform</source>. <year>2019</year>;<volume>13</volume>:<fpage>63</fpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.3389/fninf.2019.00063</pub-id>
<pub-id pub-id-type="pmid">31616273</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref009"><label>9</label><mixed-citation publication-type="journal"><name><surname>Dai</surname><given-names>K</given-names></name>, <name><surname>Hernando</surname><given-names>J</given-names></name>, <name><surname>Billeh</surname><given-names>YN</given-names></name>, <name><surname>Gratiy</surname><given-names>SL</given-names></name>, <name><surname>Planas</surname><given-names>J</given-names></name>, <name><surname>Davison</surname><given-names>AP</given-names></name>, <etal>et al</etal>. <article-title>The SONATA data format for efficient description of large-scale network models</article-title>. <source>PLoS Comput Biol</source>. <year>2020</year>;<volume>16</volume>(<issue>2</issue>):e1007696. <comment>doi: </comment><pub-id pub-id-type="doi">10.1371/journal.pcbi.1007696</pub-id>
<pub-id pub-id-type="pmid">32092054</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref010"><label>10</label><mixed-citation publication-type="book"><name><surname>Reimann</surname><given-names>MW</given-names></name>, <name><surname>Bola&#x000f1;os-Puchet</surname><given-names>S</given-names></name>, <name><surname>Courcol</surname><given-names>J-D</given-names></name>, <name><surname>Egas Santander</surname><given-names>D</given-names></name>, <name><surname>Arnaudon</surname><given-names>A</given-names></name>, <name><surname>Coste</surname><given-names>B</given-names></name>, <etal>et al</etal>. <source>Modeling and simulation of neocortical micro- and mesocircuitry. Part I: anatomy</source>. <publisher-name>Cold Spring Harbor Laboratory</publisher-name>; <year>2022</year>.</mixed-citation></ref><ref id="pcbi.1013023.ref011"><label>11</label><mixed-citation publication-type="book"><name><surname>Romani</surname><given-names>A</given-names></name>, <name><surname>Antonietti</surname><given-names>A</given-names></name>, <name><surname>Bella</surname><given-names>D</given-names></name>, <name><surname>Budd</surname><given-names>J</given-names></name>, <name><surname>Giacalone</surname><given-names>E</given-names></name>, <name><surname>Kurban</surname><given-names>K</given-names></name>, <etal>et al</etal>. <source>Community-based reconstruction and simulation of a full-scale model of region CA1 of rat hippocampus</source>. <publisher-name>Cold Spring Harbor Laboratory</publisher-name>; <year>2023</year>.</mixed-citation></ref><ref id="pcbi.1013023.ref012"><label>12</label><mixed-citation publication-type="book"><name><surname>Nunez</surname><given-names>PL</given-names></name>, <name><surname>Srinivasan</surname><given-names>R</given-names></name>. <article-title>Recording strategies, reference issues, and dipole localization</article-title>. <source>Electric fields of the brain</source>. <publisher-name>Oxford University Press</publisher-name>; <year>2006</year>. p. <fpage>275</fpage>&#x02013;<lpage>312</lpage>.</mixed-citation></ref><ref id="pcbi.1013023.ref013"><label>13</label><mixed-citation publication-type="journal"><name><surname>Moffitt</surname><given-names>MA</given-names></name>, <name><surname>McIntyre</surname><given-names>CC</given-names></name>. <article-title>Model-based analysis of cortical recording with silicon microelectrodes</article-title>. <source>Clin Neurophysiol</source>. <year>2005</year>;<volume>116</volume>(<issue>9</issue>):<fpage>2240</fpage>&#x02013;<lpage>50</lpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.1016/j.clinph.2005.05.018</pub-id>
<pub-id pub-id-type="pmid">16055377</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref014"><label>14</label><mixed-citation publication-type="journal"><name><surname>Lempka</surname><given-names>SF</given-names></name>, <name><surname>McIntyre</surname><given-names>CC</given-names></name>. <article-title>Theoretical analysis of the local field potential in deep brain stimulation applications</article-title>. <source>PLoS One</source>. <year>2013</year>;<volume>8</volume>(<issue>3</issue>):e59839. <comment>doi: </comment><pub-id pub-id-type="doi">10.1371/journal.pone.0059839</pub-id>
<pub-id pub-id-type="pmid">23555799</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref015"><label>15</label><mixed-citation publication-type="journal"><name><surname>Ness</surname><given-names>TV</given-names></name>, <name><surname>Chintaluri</surname><given-names>C</given-names></name>, <name><surname>Potworowski</surname><given-names>J</given-names></name>, <name><surname>&#x00141;&#x00119;ski</surname><given-names>S</given-names></name>, <name><surname>G&#x00142;&#x00105;bska</surname><given-names>H</given-names></name>, <name><surname>W&#x000f3;jcik</surname><given-names>DK</given-names></name>, <etal>et al</etal>. <article-title>Modelling and analysis of electrical potentials recorded in Microelectrode Arrays (MEAs)</article-title>. <source>Neuroinformatics</source>. <year>2015</year>;<volume>13</volume>(<issue>4</issue>):<fpage>403</fpage>&#x02013;<lpage>26</lpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.1007/s12021-015-9265-6</pub-id>
<pub-id pub-id-type="pmid">25822810</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref016"><label>16</label><mixed-citation publication-type="journal"><name><surname>Buccino</surname><given-names>AP</given-names></name>, <name><surname>Kuchta</surname><given-names>M</given-names></name>, <name><surname>J&#x000e6;ger</surname><given-names>KH</given-names></name>, <name><surname>Ness</surname><given-names>TV</given-names></name>, <name><surname>Berthet</surname><given-names>P</given-names></name>, <name><surname>Mardal</surname><given-names>K-A</given-names></name>, <etal>et al</etal>. <article-title>How does the presence of neural probes affect extracellular potentials?</article-title>
<source>J Neural Eng</source>. <year>2019</year>;<volume>16</volume>(<issue>2</issue>):<fpage>026030</fpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.1088/1741-2552/ab03a1</pub-id>
<pub-id pub-id-type="pmid">30703758</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref017"><label>17</label><mixed-citation publication-type="book"><name><surname>Halnes</surname><given-names>G</given-names></name>, <name><surname>Ness</surname><given-names>TV</given-names></name>, <name><surname>N&#x000e6;ss</surname><given-names>S</given-names></name>, <name><surname>Hagen</surname><given-names>E</given-names></name>, <name><surname>Pettersen</surname><given-names>KH</given-names></name>, <name><surname>Einevoll</surname><given-names>GT</given-names></name>. <source>Electric brain signals</source>. <publisher-name>Cambridge University Press</publisher-name>; <year>2024</year>.</mixed-citation></ref><ref id="pcbi.1013023.ref018"><label>18</label><mixed-citation publication-type="book"><name><surname>Holt</surname><given-names>GR</given-names></name>. A critical reexamination of some assumptions and implications of cable theory in neurobiology. <publisher-loc>Pasadena, CA</publisher-loc>: <publisher-name>California Institute of Technology</publisher-name>; <year>1997</year>.</mixed-citation></ref><ref id="pcbi.1013023.ref019"><label>19</label><mixed-citation publication-type="journal"><name><surname>Lind&#x000e9;n</surname><given-names>H</given-names></name>, <name><surname>Hagen</surname><given-names>E</given-names></name>, <name><surname>L&#x00119;ski</surname><given-names>S</given-names></name>, <name><surname>Norheim</surname><given-names>ES</given-names></name>, <name><surname>Pettersen</surname><given-names>KH</given-names></name>, <name><surname>Einevoll</surname><given-names>GT</given-names></name>. <article-title>LFPy: a tool for biophysical simulation of extracellular potentials generated by detailed model neurons</article-title>. <source>Front Neuroinform</source>. <year>2014</year>;<volume>7</volume>:<fpage>41</fpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.3389/fninf.2013.00041</pub-id>
<pub-id pub-id-type="pmid">24474916</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref020"><label>20</label><mixed-citation publication-type="book"><name><surname>Paxinos</surname><given-names>G</given-names></name>, <name><surname>Watson</surname><given-names>C</given-names></name>. <source>The rat brain in stereotaxic coordinates</source>. <edition>6th edn</edition>. <publisher-name>Academic Press/Elsevier</publisher-name>; <year>2007</year>.</mixed-citation></ref><ref id="pcbi.1013023.ref021"><label>21</label><mixed-citation publication-type="book"><name><surname>Isbister</surname><given-names>JB</given-names></name>, <name><surname>Ecker</surname><given-names>A</given-names></name>, <name><surname>Pokorny</surname><given-names>C</given-names></name>, <name><surname>Bola&#x000f1;os-Puchet</surname><given-names>S</given-names></name>, <name><surname>Egas Santander</surname><given-names>D</given-names></name>, <name><surname>Arnaudon</surname><given-names>A</given-names></name>, <etal>et al</etal>. <source>Modeling and simulation of neocortical micro- and mesocircuitry. Part II: physiology and experimentation</source>. <publisher-name>Cold Spring Harbor Laboratory</publisher-name>; <year>2023</year>.</mixed-citation></ref><ref id="pcbi.1013023.ref022"><label>22</label><mixed-citation publication-type="journal"><name><surname>Zhang</surname><given-names>J</given-names></name>, <name><surname>Treyer</surname><given-names>V</given-names></name>, <name><surname>Sun</surname><given-names>J</given-names></name>, <name><surname>Zhang</surname><given-names>C</given-names></name>, <name><surname>Gietl</surname><given-names>A</given-names></name>, <name><surname>Hock</surname><given-names>C</given-names></name>, <etal>et al</etal>. <article-title>Automatic analysis of skull thickness, scalp-to-cortex distance and association with age and sex in cognitively normal elderly</article-title>. <source>Brain Stimul</source>. <year>2023</year>;<volume>16</volume>(<issue>2</issue>):<fpage>653</fpage>&#x02013;<lpage>6</lpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.1016/j.brs.2023.03.011</pub-id>
<pub-id pub-id-type="pmid">36963563</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref023"><label>23</label><mixed-citation publication-type="journal"><name><surname>Ness</surname><given-names>TV</given-names></name>, <name><surname>Chintaluri</surname><given-names>C</given-names></name>, <name><surname>Potworowski</surname><given-names>J</given-names></name>, <name><surname>&#x00141;&#x00119;ski</surname><given-names>S</given-names></name>, <name><surname>G&#x00142;&#x00105;bska</surname><given-names>H</given-names></name>, <name><surname>W&#x000f3;jcik</surname><given-names>DK</given-names></name>, <etal>et al</etal>. <article-title>Modelling and analysis of electrical potentials recorded in Microelectrode Arrays (MEAs)</article-title>. <source>Neuroinformatics</source>. <year>2015</year>;<volume>13</volume>(<issue>4</issue>):<fpage>403</fpage>&#x02013;<lpage>26</lpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.1007/s12021-015-9265-6</pub-id>
<pub-id pub-id-type="pmid">25822810</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref024"><label>24</label><mixed-citation publication-type="journal"><name><surname>Beltrachini</surname><given-names>L</given-names></name>. <article-title>A finite element solution of the forward problem in EEG for multipolar sources</article-title>. <source>IEEE Trans Neural Syst Rehabil Eng</source>. <year>2019</year>;<volume>27</volume>(<issue>3</issue>):<fpage>368</fpage>&#x02013;<lpage>77</lpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.1109/TNSRE.2018.2886638</pub-id>
<pub-id pub-id-type="pmid">30561347</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref025"><label>25</label><mixed-citation publication-type="journal"><name><surname>Thio</surname><given-names>BJ</given-names></name>, <name><surname>Grill</surname><given-names>WM</given-names></name>. <article-title>Relative contributions of different neural sources to the EEG</article-title>. <source>Neuroimage</source>. <year>2023</year>;<volume>275</volume>:<fpage>120179</fpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.1016/j.neuroimage.2023.120179</pub-id>
<pub-id pub-id-type="pmid">37225111</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref026"><label>26</label><mixed-citation publication-type="journal"><name><surname>Vaknin</surname><given-names>G</given-names></name>, <name><surname>DiScenna</surname><given-names>PG</given-names></name>, <name><surname>Teyler</surname><given-names>TJ</given-names></name>. <article-title>A method for calculating current source density (CSD) analysis without resorting to recording sites outside the sampling volume</article-title>. <source>J Neurosci Methods</source>. <year>1988</year>;<volume>24</volume>(<issue>2</issue>):<fpage>131</fpage>&#x02013;<lpage>5</lpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.1016/0165-0270(88)90056-8</pub-id>
<pub-id pub-id-type="pmid">3405010</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref027"><label>27</label><mixed-citation publication-type="journal"><name><surname>Rimehaug</surname><given-names>AE</given-names></name>, <name><surname>Stasik</surname><given-names>AJ</given-names></name>, <name><surname>Hagen</surname><given-names>E</given-names></name>, <name><surname>Billeh</surname><given-names>YN</given-names></name>, <name><surname>Siegle</surname><given-names>JH</given-names></name>, <name><surname>Dai</surname><given-names>K</given-names></name>, <etal>et al</etal>. <article-title>Uncovering circuit mechanisms of current sinks and sources with biophysical simulations of primary visual cortex</article-title>. <source>Elife</source>. <year>2023</year>;<volume>12</volume>:e87169. <comment>doi: </comment><pub-id pub-id-type="doi">10.7554/eLife.87169</pub-id>
<pub-id pub-id-type="pmid">37486105</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref028"><label>28</label><mixed-citation publication-type="journal"><name><surname>Hagen</surname><given-names>E</given-names></name>, <name><surname>N&#x000e6;ss</surname><given-names>S</given-names></name>, <name><surname>Ness</surname><given-names>TV</given-names></name>, <name><surname>Einevoll</surname><given-names>GT</given-names></name>. <article-title>Multimodal modeling of neural network activity: computing LFP, ECoG, EEG, and MEG signals with LFPy 2.0</article-title>. <source>Front Neuroinform</source>. <year>2018</year>;<volume>12</volume>:<fpage>92</fpage>. <comment>doi: </comment><pub-id pub-id-type="doi">10.3389/fninf.2018.00092</pub-id>
<pub-id pub-id-type="pmid">30618697</pub-id>
</mixed-citation></ref><ref id="pcbi.1013023.ref029"><label>29</label><mixed-citation publication-type="journal"><name><surname>Gratiy</surname><given-names>SL</given-names></name>, <name><surname>Billeh</surname><given-names>YN</given-names></name>, <name><surname>Dai</surname><given-names>K</given-names></name>, <name><surname>Mitelut</surname><given-names>C</given-names></name>, <name><surname>Feng</surname><given-names>D</given-names></name>, <name><surname>Gouwens</surname><given-names>NW</given-names></name>, <etal>et al</etal>. <article-title>BioNet: a Python interface to NEURON for modeling large-scale networks</article-title>. <source>PLoS One</source>. <year>2018</year>;<volume>13</volume>(<issue>8</issue>):e0201630. <comment>doi: </comment><pub-id pub-id-type="doi">10.1371/journal.pone.0201630</pub-id>
<pub-id pub-id-type="pmid">30071069</pub-id>
</mixed-citation></ref></ref-list></back></article>